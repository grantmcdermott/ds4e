<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>6 Google Compute Engine (I) | Data Science for Economists and Other Animals</title>
<meta name="author" content="Grant McDermott and Ed Rubin">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-76482472-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-76482472-1');
  </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Data Science for Economists and Other Animals</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">Programming</li>
<li><a class="" href="funcs-intro.html"><span class="header-section-number">2</span> Functions: Introductory concepts</a></li>
<li><a class="" href="funcs-adv.html"><span class="header-section-number">3</span> Functions: Advanced concepts</a></li>
<li><a class="" href="parallel.html"><span class="header-section-number">4</span> Parallel programming</a></li>
<li class="book-part">Analysis</li>
<li><a class="" href="spatial-analysis.html"><span class="header-section-number">5</span> Spatial analysis</a></li>
<li class="book-part">Cloud</li>
<li><a class="active" href="gce-i.html"><span class="header-section-number">6</span> Google Compute Engine (I)</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/grantmcdermott/ds4e">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="gce-i" class="section level1">
<h1>
<span class="header-section-number">6</span> Google Compute Engine (I)<a class="anchor" aria-label="anchor" href="#gce-i"><i class="fas fa-link"></i></a>
</h1>
<p>This is the first of two chapters on Google Compute Engine. We’ll learn how to run R and RStudio Server on virtual machines (VMs) up on the cloud. This means that you’ll be able to conduct your analysis in (almost) exactly the same user environment as you’re used to, but now with the full power of cloud-based computation at your disposal. Trust us, it will be awesome.</p>
<div id="requirements-1" class="section level2">
<h2>
<span class="header-section-number">6.1</span> Requirements<a class="anchor" aria-label="anchor" href="#requirements-1"><i class="fas fa-link"></i></a>
</h2>
<div id="create-an-account-on-google-cloud-platform-free" class="section level3">
<h3>
<span class="header-section-number">6.1.1</span> Create an account on Google Cloud Platform (free)<a class="anchor" aria-label="anchor" href="#create-an-account-on-google-cloud-platform-free"><i class="fas fa-link"></i></a>
</h3>
<p>These next instructions are important, so please read carefully.</p>
<ol style="list-style-type: decimal">
<li>Sign up for a <a href="https://console.cloud.google.com/freetrial">12-month ($300 credit) free trial</a> with Google Cloud Platform (GCP). This requires an existing Google/Gmail account.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;If you have multiple Gmail accounts, please pick one and stick to it consistently whenever you are prompted to authenticate a new GCP service API.&lt;/p&gt;"><sup>36</sup></a> During the course of sign-up, you’ll be prompted to enter credit card details for billing purposes. Don’t worry, you won’t be charged unless/until you actively request continued access to GCP after your free trial ends. But a billable project ID is required before gaining access to the platform.</li>
<li>Download and follow the installation instructions for the <a href="https://cloud.google.com/sdk/">Google Cloud SDK</a> command line utility, <code>gcloud</code>. This is how we’ll connect to GCP from our local computers via the shell.</li>
</ol>
</div>
</div>
<div id="introduction" class="section level2">
<h2>
<span class="header-section-number">6.2</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction"><i class="fas fa-link"></i></a>
</h2>
<div id="to-the-cloud" class="section level3">
<h3>
<span class="header-section-number">6.2.1</span> To the cloud!<a class="anchor" aria-label="anchor" href="#to-the-cloud"><i class="fas fa-link"></i></a>
</h3>
<p>Thus far in the course, we’ve spent quite a lot of time learning how to code efficiently. We’ve covered topics like <a href="https://raw.githack.com/uo-ec607/lectures/master/10-funcs-intro/10-funcs-intro.html#functional_programming">functional programming</a>, <a href="https://raw.githack.com/uo-ec607/lectures/master/11-funcs-adv/11-funcs-adv.html#caching_(memoisation)">caching</a>, <a href="https://raw.githack.com/uo-ec607/lectures/master/12-parallel/12-parallel.html">parallel programming</a>, and so on. All of these tools will help you make the most of the computational resources at your disposal. However, there’s a limit to how far they can take you. At some point, datasets become too big, simulations become too complex, and regressions take too damn long to run to run on your laptop. The only solution beyond this point is <del>a bigger boat</del> more power.</p>
<p>The easiest and cheapest way to access more computational power these days is through the cloud.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;While the cloud is not the only game in town, it offers a variety benefits that, in our view, make it a no-brainer for most people: economies of scale make it much cheaper; maintenance and depreciation worries are taken care of; access does not hinge on institutional affiliation or faculty status; cloud providers offer a host of other useful services; etc.&lt;/p&gt;"><sup>37</sup></a> While there are a number of excellent cloud service providers, in this chapter we’re going to focus on <a href="https://console.cloud.google.com/"><strong>Google Cloud Platform</strong></a> (<strong>GCP</strong>).<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Alternatives to GCP include &lt;a href="https://aws.amazon.com/"&gt;AWS&lt;/a&gt; and &lt;a href="https://www.digitalocean.com/"&gt;Digital Ocean&lt;/a&gt;. RStudio has launched its own cloud service too: &lt;a href="https://rstudio.cloud/"&gt;RStudio Cloud&lt;/a&gt; is more narrowly focused, but is great for teaching and includes a free tier, with additional steep discounts for educators. The good news is that these are all great options and the general principles of cloud computing carry over very easily. So use whatever you feel comfortable with.&lt;/p&gt;'><sup>38</sup></a> GCP offers a range of incredibly useful services — some of which we’ll cover in later lectures — and the 12-month free trial makes an ideal entry point for learning about cloud computation.</p>
<p>The particular GCP product that we’re going to use today is <a href="https://cloud.google.com/compute/"><strong>Google Compute Engine</strong></a> (<strong>GCE</strong>). GCE is a service that allows users to launch so-called <em>virtual machines</em> on demand in the cloud (i.e. on Google’s data centers). There’s a lot more that we can say — and will say later — about the benefits can bring to us. But right now, you may well be asking yourself: “What is a virtual machine and why do I need one anyway?”</p>
<p>So, let’s take a step back and quickly clear up some terminology.</p>
</div>
<div id="virtual-machines-vms" class="section level3">
<h3>
<span class="header-section-number">6.2.2</span> Virtual machines (VMs)<a class="anchor" aria-label="anchor" href="#virtual-machines-vms"><i class="fas fa-link"></i></a>
</h3>
<p>A <a href="https://en.wikipedia.org/wiki/Virtual_machine">virtual machine (VM)</a> is just an emulation of a computer running inside another (bigger) computer. It can potentially perform all and more of the operations that your physical laptop or desktop does. It might even share many of the same properties, from operating system to internal architecture. The key advantage of a VM from our perspective is that very powerful machines can be “spun up” in the cloud almost effortlessly and then deployed to tackle jobs that are beyond the capabilities of your local computer. Got a big dataset that requires too much memory to analyse on your old laptop? Load it into a high-powered VM. Got some code that takes an age to run? Fire up a VM and let it chug away without consuming any local resources. Or, better yet, write code that <a href="https://raw.githack.com/uo-ec607/lectures/master/12-parallel/12-parallel.html">runs in parallel</a> and then spin up a VM with lots of cores to get the analysis done in a fraction of the time. All you need is a working internet connection and a web browser.</p>
<p>Now, with that background knowledge in mind, GCE delivers high-performance, rapidly scalable VMs. A new VM can be deployed or shut down within seconds, while existing VMs can easily be ramped up or down depending on a project’s needs (cores added, RAM added, etc.) In our experience, most people would be hard-pressed to spent more than a couple of dollars a month using GCE once their free trial is over. This is especially true for researchers or data scientists who only need to fire up a VM, or VM cluster, occasionally for the most computationally-intensive part of a project, and then can easily switch it off when it is not being used.</p>
<p><strong>Disclaimer:</strong> While we very much stand by the above paragraph, it is ultimately <em>your</em> responsibility to keep track of your billing and utilisation rates. Take a look at <a href="https://cloud.google.com/products/calculator/">GCP’s Pricing Calculator</a> to see how much you can expect to be charged for a particular machine and level of usage. You can even <a href="https://support.google.com/cloud/answer/6293540?hl=en">set a budget and create usage alerts</a> if you want to be extra cautious.</p>
</div>
<div id="roadmap" class="section level3">
<h3>
<span class="header-section-number">6.2.3</span> Roadmap<a class="anchor" aria-label="anchor" href="#roadmap"><i class="fas fa-link"></i></a>
</h3>
<p>Our goal for the next two chapters is to set up a VM (or cluster of VMs) on GCE. What’s more, we want to install R and RStudio (Server) on these VMs, so that we can interact with them in exactly the same environment that we’re used to on our own computers. We going to show you two approaches:</p>
<ol style="list-style-type: decimal">
<li>Manually configure GCE with RStudio Server (this chapter)</li>
<li>Automate with <strong>googleComputeEngineR</strong> and friends (next chapter)</li>
</ol>
<p>Both approaches have their merits, but we think it’s important to start with the manual configuration so that you get a good understanding of what’s happening underneath the hood. Let’s get started.</p>
</div>
</div>
<div id="install-r-and-rstudio-server-on-gce" class="section level2">
<h2>
<span class="header-section-number">6.3</span> Install R and RStudio Server on GCE<a class="anchor" aria-label="anchor" href="#install-r-and-rstudio-server-on-gce"><i class="fas fa-link"></i></a>
</h2>
<p><em><b>Note:</b> It’s possible to complete nearly all of the steps in this section via the <a href="https://console.cloud.google.com/compute/instances">GCE browser console</a>. However, we’ll stick to using the <a href="https://raw.githack.com/uo-ec607/lectures/master/03-shell/03-shell.html">shell</a>, because that will make it easier to document our steps.</em></p>
<p><em><b>Windows users:</b> You will need to run any multi-line commands (i.e. those that are chained with the <a href="https://www.gnu.org/software/bash/manual/html_node/Escape-Character.html#Escape-Character">backslash</a> character) as single line commands. Basically, delete the trailing “<code>\</code>” characters at the end of any sub-lines and run it as one long command on a single line.</em></p>
<div id="confirm-that-you-have-installed-gcloud-correctly" class="section level3">
<h3>
<span class="header-section-number">6.3.1</span> Confirm that you have installed <code>gcloud</code> correctly<a class="anchor" aria-label="anchor" href="#confirm-that-you-have-installed-gcloud-correctly"><i class="fas fa-link"></i></a>
</h3>
<p>You’ll need to choose an operating system (OS) for your VM, as well as its designated zone. Let’s quickly look at the available options, since this will also be a good time to confirm that you correctly installed the <a href="https://cloud.google.com/sdk/"><code>gcloud</code> command-line interface</a>. Open up your shell and enter:</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb144-1"><a href="gce-i.html#cb144-1"></a><span class="co">## user@localhost:~$</span></span>
<span id="cb144-2"><a href="gce-i.html#cb144-2"></a></span>
<span id="cb144-3"><a href="gce-i.html#cb144-3"></a><span class="ex">gcloud</span> compute images list</span>
<span id="cb144-4"><a href="gce-i.html#cb144-4"></a><span class="ex">gcloud</span> compute zones list</span></code></pre></div>
<blockquote>
<p><strong>Tip:</strong> If you get an error message with the above commands, try re-running them with <a href="https://en.wikipedia.org/wiki/Sudo"><code>sudo</code></a> at the beginning. If this works for you, then you will need to append “sudo” to the other shell commands in this lecture.</p>
</blockquote>
<p>You’ll know that everything is working properly if these these commands return a large range of options. If you get an error, please try <a href="https://cloud.google.com/sdk/">reinstalling</a> <code>gcloud</code> again before continuing.</p>
</div>
<div id="create-a-vm" class="section level3">
<h3>
<span class="header-section-number">6.3.2</span> Create a VM<a class="anchor" aria-label="anchor" href="#create-a-vm"><i class="fas fa-link"></i></a>
</h3>
<p>The key shell command for creating your VM is <strong><code>gcloud compute instances create</code></strong>.
You can specify the type of machine that you want and a range of other options by using the <a href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/create">appropriate flags</a>. Let me first show you an example of the command and then walk through our (somewhat arbitrary) choices in more detail. Note that we are going to call our VM instance “my-vm”, but you can call it whatever you want.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb145-1"><a href="gce-i.html#cb145-1"></a><span class="co">## user@localhost:~$</span></span>
<span id="cb145-2"><a href="gce-i.html#cb145-2"></a></span>
<span id="cb145-3"><a href="gce-i.html#cb145-3"></a><span class="ex">gcloud</span> compute instances create my-vm \</span>
<span id="cb145-4"><a href="gce-i.html#cb145-4"></a>  --image-family ubuntu-2004-lts --image-project ubuntu-os-cloud \</span>
<span id="cb145-5"><a href="gce-i.html#cb145-5"></a>  --machine-type n1-standard-8 \</span>
<span id="cb145-6"><a href="gce-i.html#cb145-6"></a>  --zone us-west1-a</span></code></pre></div>
<blockquote>
<p><strong>Tip:</strong> Windows users, remember that you can’t execute multi-line shell commands. Delete the trailing “<code>\</code>” characters above and run it as one long command on a single line.</p>
</blockquote>
<p>Here is a breakdown of the command and a quick explanation of our choices.</p>
<ul>
<li>
<code>gcloud compute instances create my-vm</code>: Create a new VM called “my-vm”. Yes, we are very creative.</li>
<li>
<code>--image-family ubuntu-2004-lts --image-project ubuntu-os-cloud</code>: Use Ubuntu 20.04 as the underlying operating system.</li>
<li>
<code>--machine-type n1-standard-8</code>: We’ve elected to go with the “N1 Standard 8” option, which means that we’re getting 8 CPUs and 30GB RAM. However, you can choose from a <a href="https://cloud.google.com/compute/pricing">range</a> of machine/memory/pricing options. (Assuming a monthly usage rate of 20 hours, this particular VM will only <a href="https://cloud.google.com/products/calculator/#id=efc1f1b1-175d-4860-ad99-9006ea39651b">cost about</a> $7.60 a month to maintain once our free trial ends.) You needn’t worry too much about these initial specs now. New VMs are very easy to create and discard once you get the hang of it. It’s also very simple to change the specs of an already-created VM. GCE will even suggest cheaper specifications if it thinks that you aren’t using your resources efficiently down the line.</li>
<li>
<code>--zone us-west1-a</code>: Our preferred zone. The zone choice shouldn’t really matter, although you’ll be prompted to choose one if you forget to include this flag. As a general rule, we advise picking whatever is closest to you.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;You can also set the default zone so that you don’t need to specify it every time. See &lt;a href="https://cloud.google.com/compute/docs/gcloud-compute/#set_default_zone_and_region_in_your_local_client"&gt;here&lt;/a&gt;.&lt;/p&gt;'><sup>39</sup></a>
</li>
</ul>
<p>Assuming that you ran the above command (perhaps changing the zone to one nearest you), you should see something like the following:</p>
<pre><code>Created [https://www.googleapis.com/compute/v1/projects/YOUR-PROJECT/zones/YOUR-ZONE/instances/YOUR-VM].
NAME   ZONE        MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP    EXTERNAL_IP   STATUS
my-vm  us-west1-a  n1-standard-8               10.138.15.222  34.105.81.92  RUNNING</code></pre>
<p>Write down the External IP address, as we’ll need it for running RStudio Server later.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;This IP address is “ephemeral” in the sense that it is only uniquely assigned to your VM while it is running continuously. This shouldn’t create any significant problems, but if you prefer a static (i.e. non-ephemeral) IP address that is always going to be associated with a particular VM instance, then this is easily done. See &lt;a href="https://cloud.google.com/compute/docs/configure-instance-ip-addresses#assign_new_instance"&gt;here&lt;/a&gt;.&lt;/p&gt;'><sup>40</sup></a></p>
<div id="allow-rstudios-8787-port-via-a-firewall-rule-only-once" class="section level4">
<h4>
<span class="header-section-number">6.3.2.1</span> Allow RStudio’s 8787 port via a firewall rule (only once)<a class="anchor" aria-label="anchor" href="#allow-rstudios-8787-port-via-a-firewall-rule-only-once"><i class="fas fa-link"></i></a>
</h4>
<p>RStudio Server runs on port 8787 of an associated IP address. Because Google Cloud by default blocks external traffic on GCE VMs for security reasons, we first need to enable the 8787 port via a <a href="https://cloud.google.com/vpc/docs/firewalls">firewall rule</a>. The following command creates a firewall rule (which we’ll call “rstudio”) that does exactly this.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb147-1"><a href="gce-i.html#cb147-1"></a><span class="co">## user@localhost:~$</span></span>
<span id="cb147-2"><a href="gce-i.html#cb147-2"></a></span>
<span id="cb147-3"><a href="gce-i.html#cb147-3"></a><span class="ex">gcloud</span> compute firewall-rules create rstudio --allow=tcp:8787</span></code></pre></div>
<p>Note that these firewall rules across every VM in a project. So you should only have to run the above command <strong>once</strong>.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;While we don’t cover it here, anyone looking to install and run &lt;a href="http://jupyter.org/"&gt;Jupyter Notebooks&lt;/a&gt; on their VM could simply amend the above command to Jupyter’s default port of 8888.&lt;/p&gt;'><sup>41</sup></a></p>
</div>
</div>
<div id="logging-in" class="section level3">
<h3>
<span class="header-section-number">6.3.3</span> Logging in<a class="anchor" aria-label="anchor" href="#logging-in"><i class="fas fa-link"></i></a>
</h3>
<p>Congratulations: Set-up for your GCE VM instance is already complete.</p>
<p>(Easy, wasn’t it?)</p>
<p>The next step is to log in via <strong>SSH</strong> (i.e. <a href="https://en.wikipedia.org/wiki/Secure_Shell"><strong>S</strong>ecure <strong>Sh</strong>ell</a>). This is a simple matter of providing your VM’s name and zone. If you forget to specify the zone or haven’t assigned a default, you’ll be prompted.</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb148-1"><a href="gce-i.html#cb148-1"></a><span class="co">## user@localhost:~$</span></span>
<span id="cb148-2"><a href="gce-i.html#cb148-2"></a></span>
<span id="cb148-3"><a href="gce-i.html#cb148-3"></a><span class="ex">gcloud</span> compute ssh my-vm --zone us-west1-a</span></code></pre></div>
<p><strong>IMPORTANT:</strong> Upon logging into a GCE instance via SSH for the first time, you will be prompted to generate a key passphrase. Needless to say, you should <em>make a note of this passphrase</em> for future long-ins. Your passphrase will be required for all future remote log-ins to Google Cloud projects via <code>gcloud</code> and SSH from your local computer. This includes additional VMs that you create under the same project account.</p>
<p>Passphrase successfully created and entered, you should now be connected to your VM via SSH. That is, you should see something like the following, where “grant” and “my-vm” will obviously be replaced by your own username and VM hostname.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb149-1"><a href="gce-i.html#cb149-1"></a><span class="ex">grant@my-vm</span>:~$</span></code></pre></div>
<p>Next, we’ll install R on our VM.</p>
</div>
<div id="install-r" class="section level3">
<h3>
<span class="header-section-number">6.3.4</span> Install R<a class="anchor" aria-label="anchor" href="#install-r"><i class="fas fa-link"></i></a>
</h3>
<p>You can find the full set of instructions and recommendations for installing R on Ubuntu <a href="https://cran.r-project.org/bin/linux/ubuntu/README.html">here</a>. Or you can just follow our choices below, which should cover everything that you need. Note that you should be running these commands directly in the shell that is connected to your VM.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb150-1"><a href="gce-i.html#cb150-1"></a><span class="co">## grant@my-vm:~$</span></span>
<span id="cb150-2"><a href="gce-i.html#cb150-2"></a></span>
<span id="cb150-3"><a href="gce-i.html#cb150-3"></a><span class="fu">sudo</span> sh -c <span class="st">'echo "deb https://cloud.r-project.org/bin/linux/ubuntu focal-cran40/" &gt;&gt; \</span></span>
<span id="cb150-4"><a href="gce-i.html#cb150-4"></a><span class="st">  /etc/apt/sources.list'</span></span>
<span id="cb150-5"><a href="gce-i.html#cb150-5"></a><span class="fu">sudo</span> apt-key adv --keyserver keyserver.ubuntu.com \</span>
<span id="cb150-6"><a href="gce-i.html#cb150-6"></a>  --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9</span>
<span id="cb150-7"><a href="gce-i.html#cb150-7"></a><span class="fu">sudo</span> apt update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt upgrade -y</span>
<span id="cb150-8"><a href="gce-i.html#cb150-8"></a><span class="fu">sudo</span> apt install -y r-base r-base-dev</span></code></pre></div>
<p><strong>Aside:</strong> Those <code>apt</code> commands are referring to the <a href="https://wiki.debian.org/Aptitude">Aptitude</a> package management system. Think of it like of <a href="https://brew.sh/">Homebrew</a> for Ubuntu (and other Debian-based Linux distributions).</p>
<p>Base R is now installed and ready to go on your VM. However, we’re going to walk you through a two extra steps, since this will avoid some common headaches down the road.</p>
<p>First, we’re going to change where we get our R libraries from:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb151-1"><a href="gce-i.html#cb151-1"></a><span class="co">## grant@my-vm:~$</span></span>
<span id="cb151-2"><a href="gce-i.html#cb151-2"></a></span>
<span id="cb151-3"><a href="gce-i.html#cb151-3"></a><span class="fu">sudo</span> sh -c <span class="st">'echo "options(repos = c(RSPM = \"https://packagemanager.rstudio.com/all/__linux__/focal/latest\"))" \</span></span>
<span id="cb151-4"><a href="gce-i.html#cb151-4"></a><span class="st">  &gt;&gt; `R RHOME`/etc/Rprofile.site'</span></span></code></pre></div>
<p>The above command sets our default library source to <a href="https://packagemanager.rstudio.com/client/#/repos/1/overview">RStudio Package Manager (<strong>RSPM</strong>)</a>, instead of the usual CRAN mirror(s). Why would we do this? Well, because RSPM provides pre-compiled R package <em>binaries</em> for Linux, whereas CRAN requires us to install and build from source. Don’t want you to worry too much about this. Just trust us that the above command will allow us to install R packages much faster and with fewer hiccups.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;If you really want to know more about the difference between “binary” vs “compiled from source”, here’s a simple analogy. A package binary is like a cake that we bought from the supermarket, while compiling a package from source is like us baking the cake at home. Why would you want to buy the cake from a supermarket? Well, it’s quicker and you might not have all the ingredients at home. Why would you make the cake yourself? Well, you might have better quality ingredients and know slightly better recipe.&lt;/p&gt;"><sup>42</sup></a></p>
<p>Second, let’s install some additional system libraries on our VM:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb152-1"><a href="gce-i.html#cb152-1"></a><span class="co">## grant@my-vm:~$ </span></span>
<span id="cb152-2"><a href="gce-i.html#cb152-2"></a></span>
<span id="cb152-3"><a href="gce-i.html#cb152-3"></a><span class="fu">sudo</span> apt install -y libudunits2-dev libgdal-dev gdal-bin libgeos-dev libproj-dev \</span>
<span id="cb152-4"><a href="gce-i.html#cb152-4"></a>  libcairo2-dev</span></code></pre></div>
<p>The above system libraries are needed to power some common R packages under the hood. For example, we’ve just installed the underlying geospatial libraries that support the <strong>sf</strong> package.</p>
</div>
<div id="install-and-configure-rstudio-server" class="section level3">
<h3>
<span class="header-section-number">6.3.5</span> Install and configure RStudio Server<a class="anchor" aria-label="anchor" href="#install-and-configure-rstudio-server"><i class="fas fa-link"></i></a>
</h3>
<p>If you followed our steps above, then you could already launch directly into R from the shell.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Enter “R” into your shell window to confirm for yourself. If you do, make sure to quit afterwards by typing in “q()”.&lt;/p&gt;"><sup>43</sup></a> However, we’d obviously prefer to use the awesome IDE interface provided by RStudio (Server). So that’s what we’ll install and configure next, making sure that we can run RStudio Server on our VM via a web browser from our local computer.</p>
<div id="download-rstudio-server-on-your-vm" class="section level4">
<h4>
<span class="header-section-number">6.3.5.1</span> Download RStudio Server on your VM<a class="anchor" aria-label="anchor" href="#download-rstudio-server-on-your-vm"><i class="fas fa-link"></i></a>
</h4>
<p>You should check what the latest available version of Rstudio Server is <a href="https://rstudio.com/products/rstudio/download-server/debian-ubuntu/">here</a>. At the time of writing, the following is what you need:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb153-1"><a href="gce-i.html#cb153-1"></a><span class="co">## grant@my-vm:~$</span></span>
<span id="cb153-2"><a href="gce-i.html#cb153-2"></a></span>
<span id="cb153-3"><a href="gce-i.html#cb153-3"></a><span class="fu">sudo</span> apt install gdebi-core</span>
<span id="cb153-4"><a href="gce-i.html#cb153-4"></a><span class="fu">wget</span> https://download2.rstudio.org/server/bionic/amd64/rstudio-server-1.4.1106-amd64.deb</span>
<span id="cb153-5"><a href="gce-i.html#cb153-5"></a><span class="fu">sudo</span> gdebi rstudio-server-1.4.1106-amd64.deb <span class="co">## Hit "y" when prompted</span></span></code></pre></div>
</div>
<div id="add-a-user" class="section level4">
<h4>
<span class="header-section-number">6.3.5.2</span> Add a user<a class="anchor" aria-label="anchor" href="#add-a-user"><i class="fas fa-link"></i></a>
</h4>
<p>Now that you’re connected to your VM, you might notice that you never actually logged in as a specific user. (More discussion <a href="https://groups.google.com/forum/#!msg/gce-discussion/DYfDOndtRTU/u_3kzNPqDAAJ">here</a>.) This doesn’t matter for most applications, but RStudio Server specifically requires a username/password combination. So we must first create a new user and give them a password before continuing. For example, we can create a new user called “elvis” like so:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb154-1"><a href="gce-i.html#cb154-1"></a><span class="co">## grant@my-vm:~$</span></span>
<span id="cb154-2"><a href="gce-i.html#cb154-2"></a></span>
<span id="cb154-3"><a href="gce-i.html#cb154-3"></a><span class="fu">sudo</span> adduser elvis</span></code></pre></div>
<p>You will then be prompted to specify a user password (and confirm various bits of biographical information which you can ignore). An optional, but recommended step is to add your new user to the <code>sudo</code> group. We’ll cover this in more depth later in the tutorial, but being part of the <code>sudo</code> group will allow Elvis to temporarily invoke superuser priviledges when needed.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb155-1"><a href="gce-i.html#cb155-1"></a><span class="co">## grant@my-v m:~$ </span></span>
<span id="cb155-2"><a href="gce-i.html#cb155-2"></a></span>
<span id="cb155-3"><a href="gce-i.html#cb155-3"></a><span class="fu">sudo</span> usermod -aG sudo elvis</span>
<span id="cb155-4"><a href="gce-i.html#cb155-4"></a><span class="co"># grant@my-vm:~$ su - elvis ## Log in as elvis on SSH (optional)</span></span></code></pre></div>
<blockquote>
<p><strong>Tip:</strong> Once created, you can now log into a user’s account on the VM directly via SSH, e.g. <code>gcloud compute ssh elvis@my-vm --zone us-west1-a</code></p>
</blockquote>
</div>
<div id="navigate-to-the-rstudio-server-instance-in-your-browser" class="section level4">
<h4>
<span class="header-section-number">6.3.5.3</span> Navigate to the RStudio Server instance in your browser<a class="anchor" aria-label="anchor" href="#navigate-to-the-rstudio-server-instance-in-your-browser"><i class="fas fa-link"></i></a>
</h4>
<p>You are now ready to open up RStudio Server by navigating to the default 8787 port of your VM’s External IP address. (You remember writing this down earlier, right?) If you forgot to write the IP address down, don’t worry: You can find it by logging into your Google Cloud console and looking at your <a href="https://console.cloud.google.com/compute/instances">VM instances</a>, or by opening up a new shell window (<strong>not</strong> the one currently connected to your VM) and typing:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb156-1"><a href="gce-i.html#cb156-1"></a><span class="co">## user@localhost:~$</span></span>
<span id="cb156-2"><a href="gce-i.html#cb156-2"></a></span>
<span id="cb156-3"><a href="gce-i.html#cb156-3"></a><span class="ex">gcloud</span> compute instances describe my-vm <span class="kw">|</span> <span class="fu">grep</span> <span class="st">'natIP'</span></span></code></pre></div>
<p>Either way, once you have the address, open up your preferred web browser and navigate to:</p>
<p><a href="http://EXTERNAL-IP-ADDRESS:8787" class="uri">http://EXTERNAL-IP-ADDRESS:8787</a></p>
<p>You will be presented with the following web page. Log in using the username/password that you created earlier.</p>
<div class="inline-figure"><img src="pics/gce-i/rstudio-server-login.png" width="100%" style="display: block; margin: auto;"></div>
<p>And we’re all set. Here is RStudio Server running on Grant’s laptop via Google Chrome.</p>
<div class="inline-figure"><img src="pics/gce-i/rstudio-server-open.png" width="100%" style="display: block; margin: auto;"></div>
<blockquote>
<p><strong>Tip:</strong> Hit F11 to go full screen in your browser. The server version of RStudio is then virtually indistinguishable from the desktop version.</p>
</blockquote>
</div>
</div>
<div id="stopping-and-restarting-your-vm-instance" class="section level3">
<h3>
<span class="header-section-number">6.3.6</span> Stopping and (re)starting your VM instance<a class="anchor" aria-label="anchor" href="#stopping-and-restarting-your-vm-instance"><i class="fas fa-link"></i></a>
</h3>
<p>Stopping and (re)starting your VM instance is a highly advisable, since you don’t want to get billed for times when you aren’t using it. In a new shell window (not the one currently synced to your VM instance):</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb157-1"><a href="gce-i.html#cb157-1"></a><span class="co">## user@localhost:~$</span></span>
<span id="cb157-2"><a href="gce-i.html#cb157-2"></a></span>
<span id="cb157-3"><a href="gce-i.html#cb157-3"></a><span class="ex">gcloud</span> compute instances stop my-vm</span>
<span id="cb157-4"><a href="gce-i.html#cb157-4"></a><span class="ex">gcloud</span> compute instances start my-vm</span></code></pre></div>
</div>
<div id="summary" class="section level3">
<h3>
<span class="header-section-number">6.3.7</span> Summary<a class="anchor" aria-label="anchor" href="#summary"><i class="fas fa-link"></i></a>
</h3>
<p>Contratulations! You now have a fully-integrated VM running R and RStudio whenever you need it. Assuming that you have gone through the initial setup, here’s the <strong>tl;dr</strong> summary of how to deploy an existing VM with RStudio Server:</p>
<ol style="list-style-type: decimal">
<li>Start up your VM instance.</li>
</ol>
<div class="sourceCode" id="cb158"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb158-1"><a href="gce-i.html#cb158-1"></a><span class="ex">gcloud</span> compute instances start YOUR-VM-INSTANCE-NAME</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Take note of the External IP address for step 3 below.</li>
</ol>
<div class="sourceCode" id="cb159"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb159-1"><a href="gce-i.html#cb159-1"></a><span class="ex">gcloud</span> compute instances describe YOUR-VM-INSTANCE-NAME <span class="kw">|</span> <span class="fu">grep</span> <span class="st">'natIP'</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li><p>Open up a web browser and navigate to RStudio Server on your VM. Enter your username and password as needed. <a href="http://EXTERNAL-IP-ADDRESS:8787" class="uri">http://EXTERNAL-IP-ADDRESS:8787</a></p></li>
<li><p>Log-in via SSH. (Optional)</p></li>
</ol>
<div class="sourceCode" id="cb160"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb160-1"><a href="gce-i.html#cb160-1"></a><span class="ex">gcloud</span> compute ssh YOUR-VM-INSTANCE-NAME</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Stop your VM.</li>
</ol>
<div class="sourceCode" id="cb161"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb161-1"><a href="gce-i.html#cb161-1"></a><span class="ex">gcloud</span> compute instances stop YOUR-VM-INSTANCE-NAME</span></code></pre></div>
<p>And, remember, if you really want to avoid the command line, then you can always go through the <a href="https://console.cloud.google.com/home/dashboard">GCE browser console</a>.</p>
</div>
</div>
<div id="getting-the-most-out-of-r-on-your-gce-setup" class="section level2">
<h2>
<span class="header-section-number">6.4</span> Getting the most out of R on your GCE setup<a class="anchor" aria-label="anchor" href="#getting-the-most-out-of-r-on-your-gce-setup"><i class="fas fa-link"></i></a>
</h2>
<p>You have already completed all of the steps that you’ll need for high-performance computing in the cloud. Any VM that you create on GCE using the above methods will be ready to go with RStudio Server whenever you want it. However, there are still a few more tweaks and tips that we can use to really improve our user experience and reduce complications when interacting with these VMs from our local computers. The rest of this tutorial covers our main tips and recommendations.</p>
<div id="keep-your-system-up-to-date" class="section level3">
<h3>
<span class="header-section-number">6.4.1</span> Keep your system up to date<a class="anchor" aria-label="anchor" href="#keep-your-system-up-to-date"><i class="fas fa-link"></i></a>
</h3>
<p>First things first: Remember to keep your VM up to date, just like you would a normal computer. We recommend that you run the following command (really: two commands) regularly:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb162-1"><a href="gce-i.html#cb162-1"></a><span class="co">## grant@my-vm:~$</span></span>
<span id="cb162-2"><a href="gce-i.html#cb162-2"></a></span>
<span id="cb162-3"><a href="gce-i.html#cb162-3"></a><span class="fu">sudo</span> apt update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt upgrade</span></code></pre></div>
<p>You can also update the <code>gcloud</code> utility components on your local computer (i.e. not your VM) with the following command:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb163-1"><a href="gce-i.html#cb163-1"></a><span class="co">## user@localhost:~</span></span>
<span id="cb163-2"><a href="gce-i.html#cb163-2"></a></span>
<span id="cb163-3"><a href="gce-i.html#cb163-3"></a><span class="ex">gcloud</span> components update</span></code></pre></div>
</div>
<div id="transfer-and-sync-files-between-your-vm-and-your-local-computer" class="section level3">
<h3>
<span class="header-section-number">6.4.2</span> Transfer and sync files between your VM and your local computer<a class="anchor" aria-label="anchor" href="#transfer-and-sync-files-between-your-vm-and-your-local-computer"><i class="fas fa-link"></i></a>
</h3>
<p>You have three main options.</p>
<div id="manually-transfer-files-directly-from-rstudio-server" class="section level4">
<h4>
<span class="header-section-number">6.4.2.1</span> 1. Manually transfer files directly from RStudio Server<a class="anchor" aria-label="anchor" href="#manually-transfer-files-directly-from-rstudio-server"><i class="fas fa-link"></i></a>
</h4>
<p>RStudio’s “Files” pane (at the bottom-right) provides various options for moving files and directories around. This includes <em>uploading</em> from your local computer to VM, or <em>exporting</em> the other way around — see the screenshot below. This is arguably the simplest option and works especially well for quick or small jobs.</p>
<div class="inline-figure"><img src="pics/gce-i/rstudio-export.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="manually-transfer-files-and-folders-using-the-command-line-or-scp" class="section level4">
<h4>
<span class="header-section-number">6.4.2.2</span> 2. Manually transfer files and folders using the command line or SCP<a class="anchor" aria-label="anchor" href="#manually-transfer-files-and-folders-using-the-command-line-or-scp"><i class="fas fa-link"></i></a>
</h4>
<p>Manually transferring files or folders across systems is done fairly easily using the command line. Note that this next code chunk would be run in a new shell instance (i.e. not the one connected to your VM via SSH).</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb164-1"><a href="gce-i.html#cb164-1"></a><span class="co">## user@localhost:~</span></span>
<span id="cb164-2"><a href="gce-i.html#cb164-2"></a></span>
<span id="cb164-3"><a href="gce-i.html#cb164-3"></a><span class="ex">gcloud</span> compute scp \</span>
<span id="cb164-4"><a href="gce-i.html#cb164-4"></a>  my-vm:/home/elvis/amazingresults.csv \</span>
<span id="cb164-5"><a href="gce-i.html#cb164-5"></a>  ~/locdir/amazingresults-copy.csv \</span>
<span id="cb164-6"><a href="gce-i.html#cb164-6"></a>  --zone us-west1-a</span></code></pre></div>
<p>It’s also possible to transfer files using your regular desktop file browser thanks to SCP. (On Linux and Mac OSX at least. Windows users first need to install a program call WinSCP.) See <a href="https://cloud.google.com/compute/docs/instances/transfer-files">here</a>.</p>
<blockquote>
<p><strong>Tip:</strong> The file browser-based SCP solution is much more efficient when you have assigned a static IP address to your VM instance — otherwise you have to set it up each time you restart your VM instance and are assigned a new ephemeral IP address — so we’d advise doing that <a href="https://cloud.google.com/compute/docs/configure-instance-ip-addresses#assign_new_instance">first</a>.</p>
</blockquote>
</div>
<div id="sync-with-github-or-other-cloud-service" class="section level4">
<h4>
<span class="header-section-number">6.4.2.3</span> 3. Sync with GitHub or other cloud service<a class="anchor" aria-label="anchor" href="#sync-with-github-or-other-cloud-service"><i class="fas fa-link"></i></a>
</h4>
<p>This is our own preferred option. Ubuntu, like all virtually Linux distros, comes with Git preinstalled. You should thus be able to sync your results across systems using Git(Hub) in the <a href="http://happygitwithr.com/">usual fashion</a>. We tend to use the command line for all our Git operations (committing, pulling, pushing, etc.) and this works exactly as expected once you’ve SSH’d into your VM. However, Rstudio Server’s built-in Git UI also works well and comes with some nice added functionality (highlighted diff. sections and so forth).</p>
<p>While we haven’t tried it ourselves, you should also be able to install <a href="http://xmodulo.com/how-to-mount-box-com-cloud-storage-on-linux.html">Box</a>, <a href="https://www.linuxbabe.com/ubuntu/install-dropbox-ubuntu-20-04">Dropbox</a> or <a href="http://www.techrepublic.com/article/how-to-mount-your-google-drive-on-linux-with-google-drive-ocamlfuse/">Google Drive</a> on your VM and sync across systems that way. If you go this route, then we’d advise installing these programs as sub-directories of the user’s “home” directory. Even then you may run into problems related to user permissions. However, just follow the instructions for linking to the hypothetical “TeamProject” folder that we describe below (except that you must obviously point towards the relevant Box/Dropbox/GDrive folder location instead) and you should be fine.</p>
<blockquote>
<p><strong>Tip:</strong> Remember that your VM lives on a server and doesn’t have the usual graphical interface — including installation utilities — of a normal desktop. You’ll thus need to follow command line installation instructions for these programs. Make sure you scroll down to the relevant sections of the links that we have provided above.</p>
</blockquote>
<p>Last, but not least, Google themselves encourage data synchronisation on GCE VMs using another product within their Cloud Platform, i.e. <a href="https://cloud.google.com/storage/">Google Storage</a>. This is especially useful for really big data files and folders, but beyond the scope of this lecture. (If you’re interested in learning more, see <a href="https://cloud.google.com/solutions/filers-on-compute-engine">here</a> and <a href="https://cloud.google.com/compute/docs/disks/gcs-buckets">here</a>.)</p>
</div>
</div>
</div>
<div id="further-resources-3" class="section level2">
<h2>
<span class="header-section-number">6.5</span> Further resources<a class="anchor" aria-label="anchor" href="#further-resources-3"><i class="fas fa-link"></i></a>
</h2>
<p>In the next chapter, we’ll build on today’s material by showing you how to automate a lot of steps with the <strong>googleComputeEngineR</strong> package and related tools. In the meantime, here are some further resources that you might find useful.</p>
<ul>
<li>We recommend consulting the official <a href="https://cloud.google.com/compute/docs/">GCE documentation</a> if you ever get stuck. There’s loads of useful advice and extra tips for getting the most out of your VM setup, including ways to integrate your system with other GCP products like Storage, BigQuery, etc.</li>
<li>Other useful links include the <a href="https://support.rstudio.com/hc/en-us/articles/234653607-Getting-Started-with-RStudio-Server">RStudio Server documentation</a>, and the <a href="https://linuxjourney.com/">Linux Journey guide</a> for anyone who wants to learn more about Linux (yes, you!).</li>
</ul>
</div>
<div id="bonus-material" class="section level2">
<h2>
<span class="header-section-number">6.6</span> Bonus material<a class="anchor" aria-label="anchor" href="#bonus-material"><i class="fas fa-link"></i></a>
</h2>
<div id="mkl" class="section level3">
<h3>
<span class="header-section-number">6.6.1</span> Install the Intel Math Kernel Library (MKL) or OpenBLAS/LAPACK<a class="anchor" aria-label="anchor" href="#mkl"><i class="fas fa-link"></i></a>
</h3>
<p>As we discussed in the previous chapter on <a href="https://raw.githack.com/uo-ec607/lectures/master/12-parallel/12-parallel.html">parallel programming</a>, R ships with its own BLAS/LAPACK libraries by default. While this default works well enough, you can get <em>significant</em> speedups by switching to more optimized libraries such as the <a href="https://software.intel.com/en-us/mkl">Intel Math Kernel Library (MKL)</a> or <a href="https://www.openblas.net/">OpenBLAS</a>. The former is slightly faster according to the benchmark tests that we’ve seen, but it’s a close run thing. Either can be installed with a simple one line command, e.g.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb165-1"><a href="gce-i.html#cb165-1"></a><span class="co">## grant@my-vm:~$ </span></span>
<span id="cb165-2"><a href="gce-i.html#cb165-2"></a></span>
<span id="cb165-3"><a href="gce-i.html#cb165-3"></a><span class="fu">sudo</span> apt install intel-mkl</span></code></pre></div>
<blockquote>
<p><strong>Tip:</strong> If you run this command in your shell (SSH), you’ll need to consent to some options. Click <code>TAB</code> on your keyboard to cycle through these and <code>ENTER</code> to select. Just to say “yes” / “okay” to everything.</p>
</blockquote>
<p>Once MKL (or OpenBLAS) is installed, your R session should automatically be configured to use it by default. You can check yourself by opening up R and checking the <code><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo()</a></code> output, which should return something like:</p>
<pre><code>BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/libmkl_rt.so</code></pre>
<p>As per our parallel programming chapter, you may also wish to switch off MKL’s default multithreading capabilities in R to avoid nested parallelism. You can use the method that we saw in that chapter, or set it as an environment variable in your .Renviron file.</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb167-1"><a href="gce-i.html#cb167-1"></a><span class="bu">echo</span> <span class="st">"MKL_NUM_THREADS=1"</span> <span class="op">&gt;&gt;</span> ~/.Renviron</span></code></pre></div>
</div>
<div id="share-files-and-libraries-between-multiple-users-on-the-same-vm" class="section level3">
<h3>
<span class="header-section-number">6.6.2</span> Share files and libraries between multiple users on the same VM<a class="anchor" aria-label="anchor" href="#share-files-and-libraries-between-multiple-users-on-the-same-vm"><i class="fas fa-link"></i></a>
</h3>
<p>The default configuration that we have described above works perfectly well in cases where you are a single user and don’t venture outside of your home directory (and its sub directories). Indeed, you can just add new folders within this user’s home directory using <a href="https://linuxjourney.com/lesson/make-directory-mkdir-command">standard Linux commands</a> and you will be able to access these from within RStudio Server when you log in as that user.</p>
<p>However, there’s a slight wrinkle in cases where you want to share information between <em>multiple</em> users on the same VM. (Which may well be necessary on a big group project.) In particular, RStudio Server is only going to be able to look for files in each individual user’s home directory (e.g. <code>/home/elvis</code>.) Similarly, by default on Linux, the R libraries that one user installs <a href="https://stackoverflow.com/a/44903158">won’t necessarily</a> be available to other users.</p>
<p>The reason has to do with user permissions; since Elvis is not an automatic “superuser”, RStudio Server doesn’t know that he is allowed to access other users’ files and packages in our VM, and vice versa. Thankfully, there’s a fairly easy workaround, involving standard Linux commands for adding user and group privileges (see <a href="https://raw.githack.com/uo-ec607/lectures/master/03-shell/03-shell.html#permissions">these slides</a> from our shell lecture). Here’s an example solution that should cover most cases:</p>
<div id="share-files-across-users" class="section level4">
<h4>
<span class="header-section-number">6.6.2.1</span> Share files across users<a class="anchor" aria-label="anchor" href="#share-files-across-users"><i class="fas fa-link"></i></a>
</h4>
<p>Let’s say that Elvis is working on a joint project together with a colleague called Priscilla. (Although, some say they are more than colleagues…) They have decided to keep all of their shared analysis in a new directory called <code>TeamProject</code>, located within Elvis’s home directory. Start by creating this new shared directory:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb168-1"><a href="gce-i.html#cb168-1"></a><span class="co">## grant@my-vm:~$ </span></span>
<span id="cb168-2"><a href="gce-i.html#cb168-2"></a></span>
<span id="cb168-3"><a href="gce-i.html#cb168-3"></a><span class="fu">sudo</span> mkdir /home/elvis/TeamProject</span></code></pre></div>
<p>Presumably, a real-life Priscilla would already have a user profile at this point. But let’s quickly create one too for our fictional version.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb169-1"><a href="gce-i.html#cb169-1"></a><span class="co">## grant@my-vm:~$ </span></span>
<span id="cb169-2"><a href="gce-i.html#cb169-2"></a></span>
<span id="cb169-3"><a href="gce-i.html#cb169-3"></a><span class="fu">sudo</span> adduser priscilla</span></code></pre></div>
<p>Next, we create a user group. We’ll call it “projectgrp”, but as you wish. The group setup is useful because once we assign a set of permissions to a group, any members of that group will automatically receive those permissions too. With that in mind, we should add Elvis and Priscilla to “projectgrp” once it is created:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb170-1"><a href="gce-i.html#cb170-1"></a><span class="co"># grant@my-vm:~$ </span></span>
<span id="cb170-2"><a href="gce-i.html#cb170-2"></a></span>
<span id="cb170-3"><a href="gce-i.html#cb170-3"></a><span class="fu">sudo</span> groupadd projectgrp</span>
<span id="cb170-4"><a href="gce-i.html#cb170-4"></a><span class="fu">sudo</span> gpasswd -a elvis projectgrp</span>
<span id="cb170-5"><a href="gce-i.html#cb170-5"></a><span class="fu">sudo</span> gpasswd -a priscilla projectgrp</span></code></pre></div>
<p>Now we can set the necessary ownership permissions to the shared <code>TeamProject</code> directory. First, we use the <code>chown</code> command to assign ownership of this directory to a default user (in this case, “elvis”) and the other “projectgrp” members. Second, we use the <code>chmod 770</code> command to grant them all read, write and execute access to the directory. In both both cases, we’ll use the <code>-R</code> flag to recursively set permissions to all children directories of <code>TeamProject/</code> too.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb171-1"><a href="gce-i.html#cb171-1"></a><span class="co">##grant@my-vm:~$</span></span>
<span id="cb171-2"><a href="gce-i.html#cb171-2"></a></span>
<span id="cb171-3"><a href="gce-i.html#cb171-3"></a><span class="fu">sudo</span> chown -R elvis:projectgrp /home/elvis/TeamProject</span>
<span id="cb171-4"><a href="gce-i.html#cb171-4"></a><span class="fu">sudo</span> chmod -R 770 /home/elvis/TeamProject</span></code></pre></div>
<p>The next two commands are optional, but advised if Priscilla is only going to be working on this VM through the <code>TeamProject</code> directory. First, you can change her primary group ID to “projectgrp”, so that all the files she creates are automatically assigned to that group:</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb172-1"><a href="gce-i.html#cb172-1"></a><span class="co">## grant@my-vm:~$</span></span>
<span id="cb172-2"><a href="gce-i.html#cb172-2"></a></span>
<span id="cb172-3"><a href="gce-i.html#cb172-3"></a><span class="fu">sudo</span> usermod -g projectgrp priscilla</span></code></pre></div>
<p>Second, you can add a symbolic link to the <code>TeamProject</code> directory in Priscilla’s home directory, so that it is immediately visible when she logs into RStudio Server. (Making sure that you switch to her account before running this command):</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb173-1"><a href="gce-i.html#cb173-1"></a><span class="co">## grant@my-vm:~$ </span></span>
<span id="cb173-2"><a href="gce-i.html#cb173-2"></a></span>
<span id="cb173-3"><a href="gce-i.html#cb173-3"></a><span class="fu">sudo</span> su - priscilla</span>
<span id="cb173-4"><a href="gce-i.html#cb173-4"></a></span>
<span id="cb173-5"><a href="gce-i.html#cb173-5"></a><span class="co">## priscilla@my-vm:~$ </span></span>
<span id="cb173-6"><a href="gce-i.html#cb173-6"></a></span>
<span id="cb173-7"><a href="gce-i.html#cb173-7"></a><span class="fu">ln</span> -s /home/elvis/TeamProject /home/priscilla/TeamProject</span>
<span id="cb173-8"><a href="gce-i.html#cb173-8"></a><span class="bu">exit</span></span>
<span id="cb173-9"><a href="gce-i.html#cb173-9"></a></span>
<span id="cb173-10"><a href="gce-i.html#cb173-10"></a><span class="co">## grant@my-vm:~$</span></span></code></pre></div>
<div id="share-r-libraries-packages-across-users" class="section level5">
<h5>
<span class="header-section-number">6.6.2.1.1</span> Share R libraries (packages) across users<a class="anchor" aria-label="anchor" href="#share-r-libraries-packages-across-users"><i class="fas fa-link"></i></a>
</h5>
<p>By default, each R package that a user installs will only be available to her.
Now, sharing R libraries across users is less critical than being able to share files. However, it’s still potentially annoying having to install, say, <strong>rstan</strong> when your colleague has already installed it under her user account. Luckily, the solution here very closely mimics the solution to file sharing that we’ve just seen above: We’re going to set a default system-wide R library path and give all of our users access to that library via a group. For convenience, we’ll just continue with the same “projectgrp” group that we created in Section <a href="gce-i.html#share-files-across-users">6.6.2.1</a>. However, you could also create a new group (say, “rusers”), add individual users to it, and proceed that way if you wanted to.</p>
<p>The first thing to do is change the permission on our system-wide R library (i.e. what you get if you type <code>R RHOME</code> in the shell). We’re going to assign read, write, and execute permissions to all of the members of our group. We’ll use the <code>-R</code> flag to do so recursively.</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb174-1"><a href="gce-i.html#cb174-1"></a><span class="co">## grant@my-vm:~$</span></span>
<span id="cb174-2"><a href="gce-i.html#cb174-2"></a></span>
<span id="cb174-3"><a href="gce-i.html#cb174-3"></a><span class="fu">sudo</span> chown elvis:projectgrp -R <span class="kw">`</span><span class="ex">R</span> RHOME<span class="kw">`</span></span>
<span id="cb174-4"><a href="gce-i.html#cb174-4"></a><span class="fu">sudo</span> chmod -R 775 <span class="kw">`</span><span class="ex">R</span> RHOME<span class="kw">`</span></span></code></pre></div>
<p>Once that’s done, tell R to make this shared library path the default for your user, by adding it to their <code>~/.Renviron</code> file. For example, here’s how we’d do it for “elvis”.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb175-1"><a href="gce-i.html#cb175-1"></a><span class="co">## grant@my-vm:~$ </span></span>
<span id="cb175-2"><a href="gce-i.html#cb175-2"></a></span>
<span id="cb175-3"><a href="gce-i.html#cb175-3"></a><span class="fu">su</span> - elvis</span>
<span id="cb175-4"><a href="gce-i.html#cb175-4"></a></span>
<span id="cb175-5"><a href="gce-i.html#cb175-5"></a><span class="co">## elvis@my-vm:~$</span></span>
<span id="cb175-6"><a href="gce-i.html#cb175-6"></a></span>
<span id="cb175-7"><a href="gce-i.html#cb175-7"></a><span class="kw">`</span><span class="ex">R</span> RHOME<span class="kw">`</span><span class="ex">/library</span> <span class="co">## Check library path. Should be /usr/lib/R/library</span></span>
<span id="cb175-8"><a href="gce-i.html#cb175-8"></a></span>
<span id="cb175-9"><a href="gce-i.html#cb175-9"></a><span class="bu">echo</span> <span class="st">'export PATH="R_LIBS_USER=/usr/lib/R/library"'</span> <span class="op">&gt;&gt;</span> ~/.Renviron</span></code></pre></div>
<p>The R packages that Elvis installs should now be immediately available to Priscilla and vice versa.</p>
<blockquote>
<p><strong>Tip:</strong> If you’ve already installed some packages in a local (i.e. this-user-only) library path before creating the system-wide setup, you can just move them across with the <a href="https://linuxjourney.com/lesson/move-mv-command">‘mv’</a> command. Something like the following should work, but you’ll need to check the appropriate paths yourself: <code>elvis@my-vm:~$ sudo mv "/home/elvis/R/x86_64-pc-linux-gnu-library/3.5/*" /usr/lib/R/library</code>.</p>
</blockquote>

<div id="refs" class="references">
<div id="ref-xie2015">
<p>Xie, Yihui. 2015. <em>Dynamic Documents with R and Knitr</em>. 2nd ed. Boca Raton, Florida: Chapman; Hall/CRC. <a href="http://yihui.org/knitr/">http://yihui.org/knitr/</a>.</p>
</div>
<div id="ref-R-bookdown">
<p>———. 2021. <em>Bookdown: Authoring Books and Technical Documents with R Markdown</em>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

















































  <div class="chapter-nav">
<div class="prev"><a href="spatial-analysis.html"><span class="header-section-number">5</span> Spatial analysis</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#gce-i"><span class="header-section-number">6</span> Google Compute Engine (I)</a></li>
<li>
<a class="nav-link" href="#requirements-1"><span class="header-section-number">6.1</span> Requirements</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#create-an-account-on-google-cloud-platform-free"><span class="header-section-number">6.1.1</span> Create an account on Google Cloud Platform (free)</a></li></ul>
</li>
<li>
<a class="nav-link" href="#introduction"><span class="header-section-number">6.2</span> Introduction</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#to-the-cloud"><span class="header-section-number">6.2.1</span> To the cloud!</a></li>
<li><a class="nav-link" href="#virtual-machines-vms"><span class="header-section-number">6.2.2</span> Virtual machines (VMs)</a></li>
<li><a class="nav-link" href="#roadmap"><span class="header-section-number">6.2.3</span> Roadmap</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#install-r-and-rstudio-server-on-gce"><span class="header-section-number">6.3</span> Install R and RStudio Server on GCE</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#confirm-that-you-have-installed-gcloud-correctly"><span class="header-section-number">6.3.1</span> Confirm that you have installed gcloud correctly</a></li>
<li><a class="nav-link" href="#create-a-vm"><span class="header-section-number">6.3.2</span> Create a VM</a></li>
<li><a class="nav-link" href="#logging-in"><span class="header-section-number">6.3.3</span> Logging in</a></li>
<li><a class="nav-link" href="#install-r"><span class="header-section-number">6.3.4</span> Install R</a></li>
<li><a class="nav-link" href="#install-and-configure-rstudio-server"><span class="header-section-number">6.3.5</span> Install and configure RStudio Server</a></li>
<li><a class="nav-link" href="#stopping-and-restarting-your-vm-instance"><span class="header-section-number">6.3.6</span> Stopping and (re)starting your VM instance</a></li>
<li><a class="nav-link" href="#summary"><span class="header-section-number">6.3.7</span> Summary</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#getting-the-most-out-of-r-on-your-gce-setup"><span class="header-section-number">6.4</span> Getting the most out of R on your GCE setup</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#keep-your-system-up-to-date"><span class="header-section-number">6.4.1</span> Keep your system up to date</a></li>
<li><a class="nav-link" href="#transfer-and-sync-files-between-your-vm-and-your-local-computer"><span class="header-section-number">6.4.2</span> Transfer and sync files between your VM and your local computer</a></li>
</ul>
</li>
<li><a class="nav-link" href="#further-resources-3"><span class="header-section-number">6.5</span> Further resources</a></li>
<li>
<a class="nav-link" href="#bonus-material"><span class="header-section-number">6.6</span> Bonus material</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#mkl"><span class="header-section-number">6.6.1</span> Install the Intel Math Kernel Library (MKL) or OpenBLAS/LAPACK</a></li>
<li><a class="nav-link" href="#share-files-and-libraries-between-multiple-users-on-the-same-vm"><span class="header-section-number">6.6.2</span> Share files and libraries between multiple users on the same VM</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/grantmcdermott/ds4e/blob/master/gce-i.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/grantmcdermott/ds4e/edit/master/gce-i.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Data Science for Economists and Other Animals</strong>" was written by Grant McDermott and Ed Rubin. It was last built on 2021-08-03.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
