<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Spatial analysis | Data Science for Economists and Other Animals</title>
<meta name="author" content="Grant McDermott and Ed Rubin">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.7.4/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4/tabs.js"></script><script src="libs/bs3compat-0.2.4/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-76482472-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-76482472-1');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Data Science for Economists and Other Animals</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">Programming</li>
<li><a class="" href="funcs-intro.html"><span class="header-section-number">2</span> Functions: Introductory concepts</a></li>
<li><a class="" href="funcs-adv.html"><span class="header-section-number">3</span> Functions: Advanced concepts</a></li>
<li><a class="" href="parallel.html"><span class="header-section-number">4</span> Parallel programming</a></li>
<li class="book-part">Analysis</li>
<li><a class="active" href="spatial-analysis.html"><span class="header-section-number">5</span> Spatial analysis</a></li>
<li class="book-part">Cloud</li>
<li><a class="" href="gce-i.html"><span class="header-section-number">6</span> Google Compute Engine (I)</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/grantmcdermott/ds4e">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="spatial-analysis" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Spatial analysis<a class="anchor" aria-label="anchor" href="#spatial-analysis"><i class="fas fa-link"></i></a>
</h1>
<div id="requirements" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Requirements<a class="anchor" aria-label="anchor" href="#requirements"><i class="fas fa-link"></i></a>
</h2>
<div id="external-libraries-requirements-vary-by-os" class="section level3" number="5.1.1">
<h3>
<span class="header-section-number">5.1.1</span> External libraries (requirements vary by OS)<a class="anchor" aria-label="anchor" href="#external-libraries-requirements-vary-by-os"><i class="fas fa-link"></i></a>
</h3>
<p>We’re going to be doing all our spatial analysis and plotting today in R. Behind the scenes, R provides bindings to powerful open-source GIS libraries. These include the <a href="http://www.gdal.org/">Geospatial Data Abstraction Library (GDAL)</a> and <a href="https://trac.osgeo.org/geos/">Interface to Geometry Engine Open Source (GEOS)</a> API suite, as well as access to projection and transformation operations from the <a href="https://proj.org">PROJ library</a>. You needn’t worry about all this, but for the fact that you <em>may</em> need to install some of these external libraries first. The requirements vary by OS:</p>
<ul>
<li>
<strong>Linux:</strong> Requirements vary by distribution. See <a href="https://github.com/r-spatial/sf#linux">here</a>.</li>
<li>
<strong>Mac:</strong> You should be fine to proceed directly to the R packages installation below. An unlikely exception is if you’ve configured R to install packages from source; in which case see <a href="https://github.com/r-spatial/sf#macos">here</a>.</li>
<li>
<strong>Windows:</strong> Same as Mac, you should be good to go unless you’re installing from source. In which case, see <a href="https://github.com/r-spatial/sf#windows">here</a>.</li>
</ul>
</div>
<div id="r-packages-3" class="section level3" number="5.1.2">
<h3>
<span class="header-section-number">5.1.2</span> R packages<a class="anchor" aria-label="anchor" href="#r-packages-3"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>New: <strong>sf</strong>, <strong>rgeos</strong>, <strong>lwgeom</strong>, <strong>maps</strong>, <strong>mapdata</strong>, <strong>spData</strong>, <strong>tigris</strong>, <strong>tidycensus</strong>, <strong>leaflet</strong>, <strong>mapview</strong>, <strong>tmap</strong>, <strong>tmaptools</strong>
</li>
<li>Already used: <strong>tidyverse</strong>, <strong>data.table</strong>, <strong>hrbrthemes</strong>
</li>
</ul>
<p>Truth be told, you only need a handful of the above libraries to do 95% of the spatial work that you’re likely to encounter. But R’s spatial ecosystem and support is extremely rich, so I’ll try to walk through a number of specific use-cases in this lecture. Run the following code chunk to install (if necessary) and load everything.</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Load and install the packages that we'll be using today</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">sf</span>, <span class="va">rgeos</span>, <span class="va">tidyverse</span>, <span class="va">data.table</span>, <span class="va">hrbrthemes</span>, <span class="va">lwgeom</span>, <span class="va">rnaturalearth</span>, <span class="va">maps</span>, <span class="va">mapdata</span>, <span class="va">spData</span>, <span class="va">tigris</span>, <span class="va">tidycensus</span>, <span class="va">leaflet</span>, <span class="va">mapview</span>, <span class="va">tmap</span>, <span class="va">tmaptools</span><span class="op">)</span>
<span class="co">## My preferred ggplot2 plotting theme (optional)</span>
<span class="fu">theme_set</span><span class="op">(</span><span class="fu">hrbrthemes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/hrbrthemes/man/theme_ipsum.html">theme_ipsum</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="census-api-key" class="section level3" number="5.1.3">
<h3>
<span class="header-section-number">5.1.3</span> Census API key<a class="anchor" aria-label="anchor" href="#census-api-key"><i class="fas fa-link"></i></a>
</h3>
<p>Finally, we’ll be accessing some data from the US Census Bureau through the <a href="https://walkerke.github.io/tidycensus/">tidycensus package</a>. This will require a Census API key, which you can request <a href="https://api.census.gov/data/key_signup.html">here</a>. Once that’s done, you can set it using the <code><a href="https://rdrr.io/pkg/tidycensus/man/census_api_key.html">tidycensus::census_api_key()</a></code> function. I recommend using the “install = TRUE” option to save your key for future usage. See the function’s help file for more information.</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tidycensus</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/census_api_key.html">census_api_key</a></span><span class="op">(</span><span class="st">"PLACE_YOUR_API_KEY_HERE"</span>, install <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="introduction-crs-and-map-projections" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Introduction: CRS and map projections<a class="anchor" aria-label="anchor" href="#introduction-crs-and-map-projections"><i class="fas fa-link"></i></a>
</h2>
<p>Student presentation time.</p>
<p>If you’re reading this after the fact, I recommend <a href="https://geocompr.robinlovelace.net/spatial-class.html#crs-intro">these</a> <a href="https://proj.org/usage/quickstart.html">two</a> helpful resources. The very short version is that spatial data, like all coordinate-based systems, only make sense relative to some fixed point. That fixed point is what the Coordinate Reference Systems, or <strong>CRS</strong>, is trying to set. In R, we can define the CRS in one of two ways:</p>
<ol style="list-style-type: decimal">
<li><p><a href="https://epsg.org/home.html">EPSG code</a> (e.g. <code>3857</code>), or</p></li>
<li><p><a href="https://proj.org/operations/index.html">PROJ string</a> (e.g. <code>"+proj=merc"</code>).</p></li>
</ol>
<p>We’ll see examples of both implementations in in this lecture. For the moment, however, just know that they are equally valid ways of specifying CRS in R (albeit with with different strengths and weaknesses). You can search for many different CRS definitions <a href="https://epsg.io/">here</a>.</p>
<blockquote>
<p><strong>Aside:</strong> There are some important updates happening in the world of CRS and geospatial software, which will percolate through to the R spatial ecosystem. Thanks to the hard work of various R package developers, these behind-the-scenes changes are unlikely to affect the way that you interact with spatial data in R. But they are worth understanding if you plan to make geospatial work a core component of your research. More <a href="https://www.r-spatial.org/r/2020/03/17/wkt.html">here</a>.</p>
</blockquote>
<p>Similarly, whenever we try to plot (some part of) the earth on a map, we’re effectively trying to <strong>project</strong> a 3-D object onto a 2-D surface. This will necessarily create some kind of distortion. Different types of map projections limit distortions for some parts of the world at the expense of others. For example, consider how badly the standard (but infamous) Mercator projection distorts the high latitudes in a global map (<a href="https://twitter.com/neilrkaye/status/1050740679008296967">source</a>):</p>
<div class="inline-figure"><img src="pics/spatial/mercator-distortion.gif" width="100%" style="display: block; margin: auto;"></div>
<p><strong>Bottom line:</strong> You should always aim to choose a projection that best represents your specific area of study. I’ll also show you how you can “re-orient” your projection to a specific latitude and longitude using the PROJ syntax. But first I’m obliged to share this <a href="https://xkcd.com/977/">XKCD summary</a>. (Do yourself a favour and click on the link.)</p>
</div>
<div id="simple-features-and-the-sf-package" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Simple Features and the <strong>sf</strong> package<a class="anchor" aria-label="anchor" href="#simple-features-and-the-sf-package"><i class="fas fa-link"></i></a>
</h2>
<p>R has long provided excellent support for spatial analysis and plotting (primarily through the <strong>sp</strong>, <strong>rgdal</strong>, <strong>rgeos</strong>, and <strong>raster</strong> packages). However, until recently, the complex structure of spatial data necessitated a set of equally complex spatial objects in R. I won’t go into details, but a spatial object (say, a <a href="https://cran.r-project.org/web/packages/sp/vignettes/intro_sp.pdf">SpatialPolygonsDataFrame</a>) was typically comprised of several “layers” — much like a list — with each layer containing a variety of “slots.” While this approach did (and still does) work perfectly well, the convoluted structure provided some barriers to entry for newcomers. It also made it very difficult to incorporate spatial data into the tidyverse ecosystem that we’re familiar with. Luckily, all this has changed thanks to the advent of the <strong>sf</strong> package (<a href="https://r-spatial.github.io/sf/">link</a>).</p>
<p>The “sf” stands for <a href="https://en.wikipedia.org/wiki/Simple_Features"><strong>s</strong>imple <strong>f</strong>eatures</a>, which is a simple (ahem) standard for representing the spatial geometries of real-world objects on a computer.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;See the &lt;a href="https://r-spatial.github.io/sf/articles/sf1.html"&gt;first&lt;/a&gt; of the excellent &lt;strong&gt;sf&lt;/strong&gt; vignettes for more details.&lt;/p&gt;'><sup>28</sup></a> These objects — i.e. “features” — could include a tree, a building, a country’s border, or the entire globe. The point is that they are characterised by a common set of rules, defining everything from how they are stored on our computer to which geometrical operations can be applied them. Of greater importance for our purposes, however, is the fact that <strong>sf</strong> represents these features in R as <em>data frames</em>. This means that all of our data wrangling skills from previous lectures can be applied to spatial data; say nothing of the specialized spatial functions that we’ll cover next.</p>
<div id="reading-in-spatial-data" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> Reading in spatial data<a class="anchor" aria-label="anchor" href="#reading-in-spatial-data"><i class="fas fa-link"></i></a>
</h3>
<p>Somewhat confusingly, most of the functions in the <strong>sf</strong> package start with the prefix <code>st_</code>. This stands for <em><b>s</b>patial and <b>t</b>emporal</em> and a basic command of this package is easy enough once you remember that you’re probably looking for <code>st_SOMETHING()</code>.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;I rather wish they’d gone with a &lt;code&gt;sf_&lt;/code&gt; prefix myself — or at least created aliases for it — but the package developers are apparently following &lt;a href="https://github.com/r-spatial/sf/issues/140#issuecomment-270029715"&gt;standard naming conventions from PostGIS&lt;/a&gt;.&lt;/p&gt;'><sup>29</sup></a></p>
<p>Let’s demonstrate by reading in the North Carolina counties shapefile that comes bundled with <strong>sf</strong>. As you might have guessed, we’re going to use the <code>st_read()</code> command and <strong>sf</strong> package will handle all the heavy lifting behind the scenes.</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(sf) ## Already loaded</span>

<span class="co">## Location of our shapefile (here: bundled together with the sf package)</span>
<span class="va">file_loc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"shape/nc.shp"</span>, package<span class="op">=</span><span class="st">"sf"</span><span class="op">)</span>

<span class="co">## Read the shapefile into R</span>
<span class="va">nc</span> <span class="op">=</span> <span class="fu">st_read</span><span class="op">(</span><span class="va">file_loc</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="simple-features-as-data-frames" class="section level3" number="5.3.2">
<h3>
<span class="header-section-number">5.3.2</span> Simple Features as data frames<a class="anchor" aria-label="anchor" href="#simple-features-as-data-frames"><i class="fas fa-link"></i></a>
</h3>
<p>Let’s print out the <code>nc</code> object that we just created and take a look at its structure.</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc</span>
<span class="co">#&gt; Simple feature collection with 100 features and 14 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span>
<span class="co">#&gt; geographic CRS: NAD27</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;     AREA PERIMETER CNTY_ CNTY_ID        NAME  FIPS FIPSNO CRESS_ID BIR74 SID74</span>
<span class="co">#&gt; 1  0.114     1.442  1825    1825        Ashe 37009  37009        5  1091     1</span>
<span class="co">#&gt; 2  0.061     1.231  1827    1827   Alleghany 37005  37005        3   487     0</span>
<span class="co">#&gt; 3  0.143     1.630  1828    1828       Surry 37171  37171       86  3188     5</span>
<span class="co">#&gt; 4  0.070     2.968  1831    1831   Currituck 37053  37053       27   508     1</span>
<span class="co">#&gt; 5  0.153     2.206  1832    1832 Northampton 37131  37131       66  1421     9</span>
<span class="co">#&gt; 6  0.097     1.670  1833    1833    Hertford 37091  37091       46  1452     7</span>
<span class="co">#&gt; 7  0.062     1.547  1834    1834      Camden 37029  37029       15   286     0</span>
<span class="co">#&gt; 8  0.091     1.284  1835    1835       Gates 37073  37073       37   420     0</span>
<span class="co">#&gt; 9  0.118     1.421  1836    1836      Warren 37185  37185       93   968     4</span>
<span class="co">#&gt; 10 0.124     1.428  1837    1837      Stokes 37169  37169       85  1612     1</span>
<span class="co">#&gt;    NWBIR74 BIR79 SID79 NWBIR79                       geometry</span>
<span class="co">#&gt; 1       10  1364     0      19 MULTIPOLYGON (((-81.47276 3...</span>
<span class="co">#&gt; 2       10   542     3      12 MULTIPOLYGON (((-81.23989 3...</span>
<span class="co">#&gt; 3      208  3616     6     260 MULTIPOLYGON (((-80.45634 3...</span>
<span class="co">#&gt; 4      123   830     2     145 MULTIPOLYGON (((-76.00897 3...</span>
<span class="co">#&gt; 5     1066  1606     3    1197 MULTIPOLYGON (((-77.21767 3...</span>
<span class="co">#&gt; 6      954  1838     5    1237 MULTIPOLYGON (((-76.74506 3...</span>
<span class="co">#&gt; 7      115   350     2     139 MULTIPOLYGON (((-76.00897 3...</span>
<span class="co">#&gt; 8      254   594     2     371 MULTIPOLYGON (((-76.56251 3...</span>
<span class="co">#&gt; 9      748  1190     2     844 MULTIPOLYGON (((-78.30876 3...</span>
<span class="co">#&gt; 10     160  2038     5     176 MULTIPOLYGON (((-80.02567 3...</span></code></pre></div>
<p>Now we can see the explicit data frame structure that was I talking about earlier. The object has the familiar tibble-style output that we’re used to (e.g. it only prints the first 10 rows of the data). However, it also has some additional information in the header, like a description of the geometry type (“MULTIPOLYGON”) and CRS (e.g. EPSG ID 4267). One thing I want to note in particular is the <code>geometry</code> column right at the end of the data frame. This geometry column is how <strong>sf</strong> package achieves much of its magic: It stores the geometries of each row element in its own list column.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;For example, we could print out the coordinates needed to plot the first element in our data frame, Ashe county, by typing &lt;code&gt;nc$geometry[[1]]&lt;/code&gt;. In contrast, I invite you to see how complicated the structure of a traditional spatial object is by running, say, &lt;code&gt;str(as(nc, "Spatial"))&lt;/code&gt;.&lt;/p&gt;'><sup>30</sup></a> Since all we really care about are the key feature attributes — county name, FIPS code, population size, etc. — we can focus on those instead of getting bogged down by hundreds (or thousands or even millions) of coordinate points. In turn, this all means that our favourite <strong>tidyverse</strong> operations and syntax (including the pipe operator <code><a href="https://rstudio.github.io/bslib//reference/pipe.html">%&gt;%</a></code>) can be applied to spatial data. Let’s review some examples, starting with plotting.</p>
</div>
<div id="plotting-and-projection-with-ggplot2" class="section level3" number="5.3.3">
<h3>
<span class="header-section-number">5.3.3</span> Plotting and projection with <strong>ggplot2</strong><a class="anchor" aria-label="anchor" href="#plotting-and-projection-with-ggplot2"><i class="fas fa-link"></i></a>
</h3>
<p>Plotting <strong>sf</strong> objects is incredibly easy thanks to the package’s integration with both base R <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> and <strong>ggplot2</strong>. I’m going to focus on the latter here, but feel free to experiment.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Plotting &lt;strong&gt;sf&lt;/strong&gt; objects with the base &lt;code&gt;plot&lt;/code&gt; function is generally faster. However, I feel that you give up a lot of control and intuition by moving away from the layered, “graphics of grammar” approach of &lt;strong&gt;ggplot2&lt;/strong&gt;.&lt;/p&gt;"><sup>31</sup></a> The key geom to remember is <code>geom_sf()</code>. For example:</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(tidyverse) ## Already loaded</span>

<span class="va">nc_plot</span> <span class="op">=</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="va">nc</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">AREA</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, col<span class="op">=</span><span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Area"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Counties of North Carolina"</span><span class="op">)</span>

<span class="va">nc_plot</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/nc_plot-1.png" width="672" style="display: block; margin: auto;"></div>
<p>To reproject an <strong>sf</strong> object to a different CRS, we can use <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">sf::st_transform()</a></code>.</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc</span> <span class="op">%&gt;%</span>
  <span class="fu">st_transform</span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"+proj=moll"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Reprojecting to a Mollweide CRS</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="co">## Saving vertical space</span>
<span class="co">#&gt; Simple feature collection with 2 features and 14 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -7160488 ymin: 4364312 xmax: -7077217 ymax: 4404766</span>
<span class="co">#&gt; CRS:            +proj=moll</span>
<span class="co">#&gt;    AREA PERIMETER CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 SID74</span>
<span class="co">#&gt; 1 0.114     1.442  1825    1825      Ashe 37009  37009        5  1091     1</span>
<span class="co">#&gt; 2 0.061     1.231  1827    1827 Alleghany 37005  37005        3   487     0</span>
<span class="co">#&gt;   NWBIR74 BIR79 SID79 NWBIR79                       geometry</span>
<span class="co">#&gt; 1      10  1364     0      19 MULTIPOLYGON (((-7145982 43...</span>
<span class="co">#&gt; 2      10   542     3      12 MULTIPOLYGON (((-7118092 43...</span></code></pre></div>
<p>Or, we can specify a common projection directly in the ggplot call using <code>coord_sf()</code>. This is often the most convenient approach when you are combining multiple <strong>sf</strong> data frames in the same plot.</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc_plot</span> <span class="op">+</span>
  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"+proj=moll"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Mollweide projection"</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/nc_mollweide_plot-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Note that we used a PROJ string to define the CRS reprojection above. But we could easily use an EPSG code instead. For example, here’s the <a href="https://epsg.io/32119">NC state plane</a> projection.</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc_plot</span> <span class="op">+</span>
  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">32119</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"NC state plane"</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/nc_stateline_plot-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="data-wrangling-with-dplyr-and-tidyr" class="section level3" number="5.3.4">
<h3>
<span class="header-section-number">5.3.4</span> Data wrangling with <strong>dplyr</strong> and <strong>tidyr</strong><a class="anchor" aria-label="anchor" href="#data-wrangling-with-dplyr-and-tidyr"><i class="fas fa-link"></i></a>
</h3>
<p>As I keep saying, the tidyverse approach to data wrangling carries over very smoothly to <strong>sf</strong> objects. For example, the standard <strong>dplyr</strong> verbs like <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>, <code>mutate()</code> and <code>select()</code> all work:</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Camden"</span>, <span class="st">"Durham"</span>, <span class="st">"Northampton"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>AREA_1000 <span class="op">=</span> <span class="va">AREA</span><span class="op">*</span><span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">NAME</span>, <span class="fu">contains</span><span class="op">(</span><span class="st">"AREA"</span><span class="op">)</span>, <span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 3 features and 15 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -79.01814 ymin: 35.85786 xmax: -75.95718 ymax: 36.55629</span>
<span class="co">#&gt; geographic CRS: NAD27</span>
<span class="co">#&gt;          NAME  AREA AREA_1000 PERIMETER CNTY_ CNTY_ID  FIPS FIPSNO CRESS_ID</span>
<span class="co">#&gt; 1 Northampton 0.153       153     2.206  1832    1832 37131  37131       66</span>
<span class="co">#&gt; 2      Camden 0.062        62     1.547  1834    1834 37029  37029       15</span>
<span class="co">#&gt; 3      Durham 0.077        77     1.271  1908    1908 37063  37063       32</span>
<span class="co">#&gt;   BIR74 SID74 NWBIR74 BIR79 SID79 NWBIR79                       geometry</span>
<span class="co">#&gt; 1  1421     9    1066  1606     3    1197 MULTIPOLYGON (((-77.21767 3...</span>
<span class="co">#&gt; 2   286     0     115   350     2     139 MULTIPOLYGON (((-76.00897 3...</span>
<span class="co">#&gt; 3  7970    16    3732 10432    22    4948 MULTIPOLYGON (((-79.01814 3...</span></code></pre></div>
<p>You can also perform <code>group_by()</code> and <code>summarise()</code> operations as per normal (see <a href="http://strimas.com/r/tidy-sf/">here</a> for a nice example). Furthermore, the <strong>dplyr</strong> family of <a href="https://dplyr.tidyverse.org/reference/join.html">join functions</a> also work, which can be especially handy when combining different datasets by (say) FIPS code or some other <em>attribute</em>. However, this presumes that only one of the objects has a specialized geometry column. In other words, it works when you are joining an <strong>sf</strong> object with a normal data frame. In cases where you want to join two <strong>sf</strong> objects based on their <em>geometries</em>, there’s a specialized <code>st_join()</code> function. I provide an example of this latter operation in the section on <a href="spatial-analysis.html#geometric">geometric operations</a> below.</p>
<p>And, just to show that we’ve got the bases covered, you can also implement your favourite <strong>tidyr</strong> verbs. For example, we can <code><a href="https://tidyr.tidyverse.org/reference/gather.html">tidyr::gather()</a></code> the data to long format, which is useful for facetted plotting.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;In case you’re wondering: the newer &lt;code&gt;tidyr::pivot_*&lt;/code&gt; functions &lt;a href="https://github.com/r-spatial/sf/pull/1151"&gt;do not&lt;/a&gt; yet work with &lt;strong&gt;sf&lt;/strong&gt; objects.&lt;/p&gt;'><sup>32</sup></a> Here I demonstrate using the “BIR74” and “BIR79” columns (i.e. the number of births in each county in 1974 and 1979, respectively).</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span>county <span class="op">=</span> <span class="va">NAME</span>, <span class="va">BIR74</span>, <span class="va">BIR79</span>, <span class="op">-</span><span class="va">geometry</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">gather</span><span class="op">(</span><span class="va">year</span>, <span class="va">births</span>, <span class="va">BIR74</span>, <span class="va">BIR79</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"BIR"</span>, <span class="st">"19"</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">births</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, col<span class="op">=</span><span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Births"</span>, labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/label_number.html">comma</a></span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">year</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Births by North Carolina county"</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/nc_tidyr-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="geometric" class="section level3" number="5.3.5">
<h3>
<span class="header-section-number">5.3.5</span> Specialized geometric operations<a class="anchor" aria-label="anchor" href="#geometric"><i class="fas fa-link"></i></a>
</h3>
<p>Alongside all the tidyverse functionality, the <strong>sf</strong> package comes with a full suite of geometrical operations. You should take a look at at the <a href="https://r-spatial.github.io/sf/articles/sf3.html#geometrical-operations">third <strong>sf</strong> vignette</a> or the <a href="https://geocompr.robinlovelace.net/geometric-operations.html#geo-vec"><em>Geocomputation with R</em></a> book to get a complete overview. However, here are a few examples to get you started:</p>
<div id="unary-operations" class="section level4" number="5.3.5.1">
<h4>
<span class="header-section-number">5.3.5.1</span> Unary operations<a class="anchor" aria-label="anchor" href="#unary-operations"><i class="fas fa-link"></i></a>
</h4>
<p>So-called <em>unary</em> operations are applied to a single object. For instance, you can “melt” sub-elements of an <strong>sf</strong> object (e.g. counties) into larger elements (e.g. states) using <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">sf::st_union()</a></code>:</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc</span> <span class="op">%&gt;%</span> 
  <span class="fu">st_union</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>fill<span class="op">=</span><span class="cn">NA</span>, col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Outline of North Carolina"</span><span class="op">)</span> 
<span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/nc_union-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Or, you can get the <code>st_area()</code>, <code>st_centroid()</code>, <code>st_boundary()</code>, <code>st_buffer()</code>, etc. of an object using the appropriate command. For example:</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc</span> <span class="op">%&gt;%</span> <span class="fu">st_area</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span> <span class="co">## Only show the area of the first five counties to save space.</span>
<span class="co">#&gt; Units: [m^2]</span>
<span class="co">#&gt; [1] 1137388604  611077263 1423489919  694546292 1520740530</span></code></pre></div>
<p>And:</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc_centroid</span> <span class="op">=</span> <span class="fu">st_centroid</span><span class="op">(</span><span class="va">nc</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">nc</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"black"</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>, col <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">nc_centroid</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> <span class="co">## Notice how easy it is to combine different sf objects</span>
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Counties of North Carolina"</span>,
    subtitle <span class="op">=</span> <span class="st">"Centroids in red"</span>
    <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/nc_centroid-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="binary-operations" class="section level4" number="5.3.5.2">
<h4>
<span class="header-section-number">5.3.5.2</span> Binary operations<a class="anchor" aria-label="anchor" href="#binary-operations"><i class="fas fa-link"></i></a>
</h4>
<p>Another set of so-called <em>binary</em> operations can be applied to multiple objects. So, we can get things like the distance between two spatial objects using <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">sf::st_distance()</a></code>. In the below example, I’m going to get the distance from Ashe county to Brunswich county, as well as itself. The latter is just a silly addition to show that we can easily make multiple pairwise comparisons, even when the distance from one element to another is zero.</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ashe_brunswick</span> <span class="op">=</span> <span class="va">nc</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ashe"</span>, <span class="st">"Brunswick"</span><span class="op">)</span><span class="op">)</span>
<span class="va">brunswick</span> <span class="op">=</span> <span class="va">nc</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Brunswick"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Use "by_element = TRUE" to give a vector instead of the default pairwise matrix</span>
<span class="va">ab_dist</span> <span class="op">=</span> <span class="fu">st_distance</span><span class="op">(</span><span class="va">ashe_brunswick</span>, <span class="va">brunswick</span>, by_element <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># Units: [m]</span>
<span class="co"># [1] 347930.7      0.0</span>

<span class="co">## We can use the `units` package (already installed as sf dependency) to convert to kilometres </span>
<span class="va">ab_dist</span> <span class="op">=</span> <span class="va">ab_dist</span> <span class="op">%&gt;%</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html">set_units</a></span><span class="op">(</span><span class="va">km</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># Units: [km]</span>
<span class="co"># [1] 348   0</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">nc</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"black"</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>, col <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">nc</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ashe"</span>, <span class="st">"Brunswick"</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>  
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Calculating distances"</span>,
    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"The distance between Ashe and Brunswick is "</span>, <span class="va">ab_dist</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" km"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/nc_distance-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="binary-logical-operations" class="section level4" number="5.3.5.3">
<h4>
<span class="header-section-number">5.3.5.3</span> Binary logical operations<a class="anchor" aria-label="anchor" href="#binary-logical-operations"><i class="fas fa-link"></i></a>
</h4>
<p>A sub-genre of binary geometric operations falls into the category of logic rules — typically characterising the way that geometries relate in space. (Do they overlap, etc.)</p>
<p>For example, we can calculate the intersection of different spatial objects using <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code>. For this next example, I’m going to use two new spatial objects: 1) A regional map of France from the <strong>maps</strong> package and 2) part of the Seine river network (including its Marne and Yonne tributaries) from the <strong>spData</strong> package. Don’t worry too much about the process used for loading these datasets; I’ll cover that in more depth shortly. For the moment, just focus on the idea that we want to see which adminstrative regions are intersected by the river network. Start by plotting all of the data to get a visual sense of the overlap:</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Get the data</span>
<span class="va">france</span> <span class="op">=</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="fu">map</span><span class="op">(</span><span class="st">'france'</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"seine"</span>, package <span class="op">=</span> <span class="st">"spData"</span><span class="op">)</span>

<span class="co">## Make sure they have the same projection</span>
<span class="va">seine</span> <span class="op">=</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">seine</span>, crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="va">france</span><span class="op">)</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">france</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>, fill <span class="op">=</span> <span class="st">"black"</span>, col <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seine</span>, col <span class="op">=</span> <span class="st">"#05E9FF"</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Administrative regions of France"</span>,
    subtitle <span class="op">=</span> <span class="st">"Also showing the Seine, Marne and Yonne rivers"</span>
    <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/france-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Now let’s limit it to the intersected regions:</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">seine</span> <span class="op">=</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">seine</span>, crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="va">france</span><span class="op">)</span><span class="op">)</span>
<span class="va">france_intersected</span> <span class="op">=</span> <span class="fu">st_intersection</span><span class="op">(</span><span class="va">france</span>, <span class="va">seine</span><span class="op">)</span>
<span class="va">france_intersected</span>
<span class="co">#&gt; Simple feature collection with 22 features and 2 fields</span>
<span class="co">#&gt; geometry type:  GEOMETRY</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: 0.4931747 ymin: 47.04007 xmax: 5.407725 ymax: 49.52717</span>
<span class="co">#&gt; geographic CRS: WGS 84</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;                     ID  name                           geom</span>
<span class="co">#&gt; 6                Aisne Marne LINESTRING (3.608053 49.089...</span>
<span class="co">#&gt; 14               Marne Marne LINESTRING (4.872966 48.637...</span>
<span class="co">#&gt; 17      Seine-et-Marne Marne LINESTRING (3.254238 48.977...</span>
<span class="co">#&gt; 19   Seine-Saint-Denis Marne LINESTRING (2.595133 48.876...</span>
<span class="co">#&gt; 25        Val-de-Marne Marne LINESTRING (2.53346 48.8581...</span>
<span class="co">#&gt; 30         Haute-Marne Marne LINESTRING (5.407725 47.877...</span>
<span class="co">#&gt; 5       Seine-Maritime Seine LINESTRING (1.071621 49.309...</span>
<span class="co">#&gt; 12                Eure Seine LINESTRING (1.514229 49.077...</span>
<span class="co">#&gt; 14.1             Marne Seine LINESTRING (3.868337 48.522...</span>
<span class="co">#&gt; 15           Val-Doise Seine LINESTRING (2.286567 48.954...</span></code></pre></div>
<p>Note that <code>st_intersection()</code> only preserves <em>exact</em> points of overlap. As in, this is the exact path that the rivers follow within these regions. We can see this more explicitly in map form:</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">france_intersected</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.8</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">ID</span>, col <span class="op">=</span> <span class="va">ID</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Seine, Marne and Yonne rivers"</span>,
    caption <span class="op">=</span> <span class="st">"Colours depict French administrative regions"</span>
    <span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/france_intersected_plot-1.png" width="672" style="display: block; margin: auto;"></div>
<p>If we instead wanted to plot the subsample of intersected provinces (i.e. keeping their full geometries), we have a couple options. We could filter the <code>france</code> object by matching its region IDs with the <code>france_intersected</code> object. However, a more direct option is to use the <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> function which matches objects based on overlapping (i.e. intersecting) geometries:</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">st_join</span><span class="op">(</span><span class="va">france</span>, <span class="va">seine</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Get rid of regions with no overlap</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="va">ID</span>, .keep_all <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Some regions are duplicated b/c two branches of the river network flow through them </span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.8</span>, fill <span class="op">=</span> <span class="st">"black"</span>, col <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seine</span>, col <span class="op">=</span> <span class="st">"#05E9FF"</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Intersected regions only"</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/france_join-1.png" width="672" style="display: block; margin: auto;"></div>
<p>That’s about as much <strong>sf</strong> functionality as I can show you for today. The remaining part of this lecture will cover some additional mapping considerations and some bonus spatial R “swag.” However, I’ll try to slip in a few more <strong>sf</strong>-specific operations along the way.</p>
</div>
</div>
<div id="aside-sf-and-data.table" class="section level3" number="5.3.6">
<h3>
<span class="header-section-number">5.3.6</span> Aside: <strong>sf</strong> and <strong>data.table</strong><a class="anchor" aria-label="anchor" href="#aside-sf-and-data.table"><i class="fas fa-link"></i></a>
</h3>
<p><strong>sf</strong> objects are designed to integrate with a <strong>tidyverse</strong> workflow. They can also be made to work a <strong>data.table</strong> workflow too, but the integration is not as slick. This is a <a href="https://github.com/Rdatatable/data.table/issues/2273">known issue</a> and I’ll only just highlight a few very brief considerations.</p>
<p>You can convert an <strong>sf</strong> object into a data.table. But note that the key geometry column appears to lose its attributes.</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(data.table) ## Already loaded</span>

<span class="va">nc_dt</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">nc_dt</span><span class="op">)</span>
<span class="co">#&gt;     AREA PERIMETER CNTY_ CNTY_ID        NAME  FIPS FIPSNO CRESS_ID BIR74 SID74</span>
<span class="co">#&gt; 1: 0.114     1.442  1825    1825        Ashe 37009  37009        5  1091     1</span>
<span class="co">#&gt; 2: 0.061     1.231  1827    1827   Alleghany 37005  37005        3   487     0</span>
<span class="co">#&gt; 3: 0.143     1.630  1828    1828       Surry 37171  37171       86  3188     5</span>
<span class="co">#&gt; 4: 0.070     2.968  1831    1831   Currituck 37053  37053       27   508     1</span>
<span class="co">#&gt; 5: 0.153     2.206  1832    1832 Northampton 37131  37131       66  1421     9</span>
<span class="co">#&gt; 6: 0.097     1.670  1833    1833    Hertford 37091  37091       46  1452     7</span>
<span class="co">#&gt;    NWBIR74 BIR79 SID79 NWBIR79 geometry</span>
<span class="co">#&gt; 1:      10  1364     0      19  &lt;XY[1]&gt;</span>
<span class="co">#&gt; 2:      10   542     3      12  &lt;XY[1]&gt;</span>
<span class="co">#&gt; 3:     208  3616     6     260  &lt;XY[1]&gt;</span>
<span class="co">#&gt; 4:     123   830     2     145  &lt;XY[3]&gt;</span>
<span class="co">#&gt; 5:    1066  1606     3    1197  &lt;XY[1]&gt;</span>
<span class="co">#&gt; 6:     954  1838     5    1237  &lt;XY[1]&gt;</span></code></pre></div>
<p>The good news is that all of this information is still there. It’s just hidden from display.</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc_dt</span><span class="op">$</span><span class="va">geometry</span>
<span class="co">#&gt; Geometry set for 100 features </span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span>
<span class="co">#&gt; geographic CRS: NAD27</span>
<span class="co">#&gt; First 5 geometries:</span>
<span class="co">#&gt; MULTIPOLYGON (((-81.47276 36.23436, -81.54084 3...</span>
<span class="co">#&gt; MULTIPOLYGON (((-81.23989 36.36536, -81.24069 3...</span>
<span class="co">#&gt; MULTIPOLYGON (((-80.45634 36.24256, -80.47639 3...</span>
<span class="co">#&gt; MULTIPOLYGON (((-76.00897 36.3196, -76.01735 36...</span>
<span class="co">#&gt; MULTIPOLYGON (((-77.21767 36.24098, -77.23461 3...</span></code></pre></div>
<p>What’s the upshot? Well, basically it means that you have to refer to this “geometry” column explicitly whenever you implement a spatial operation. For example, here’s a repeat of the <code>st_union()</code> operation that we saw earlier. Note that I explicitly refer to the “geometry” column both for the <code>st_union()</code> operation (which, moreover, takes place in the
“j” data.table slot) and when assigning the aesthetics for the <code>ggplot()</code> call.</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc_dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>geometry <span class="op">=</span> <span class="fu">st_union</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="co">## Explicitly refer to 'geometry' col</span>
    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>        <span class="co">## And here again for the aes()</span>
    <span class="fu">geom_sf</span><span class="op">(</span>fill<span class="op">=</span><span class="cn">NA</span>, col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Outline of North Carolina"</span>, 
         subtitle <span class="op">=</span> <span class="st">"This time brought to you by data.table"</span><span class="op">)</span> 
<span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/ncd_dt3-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Of course, it’s also possible to efficiently convert between the two classes — e.g. with <code><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table()</a></code> and <code>st_as_sf()</code> — depending on what a particular section of code does (data wrangling or spatial operation). I find that often use this approach in my own work.</p>
</div>
</div>
<div id="where-to-get-map-data" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> Where to get map data<a class="anchor" aria-label="anchor" href="#where-to-get-map-data"><i class="fas fa-link"></i></a>
</h2>
<p>As our first North Carolina examples demonstrate, you can easily import external shapefiles, KML files, etc., into R. Just use the generic <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">sf::st_read()</a></code> function on any of these formats and the <strong>sf</strong> package will take care of the rest. However, we’ve also seen with the France example that you might not even need an external shapefile. Indeed, R provides access to a large number of base maps — e.g. countries of the world, US states and counties, etc. — through the <strong>maps</strong>, (higher resolution) <strong>mapdata</strong> and <strong>spData</strong> packages, as well as a whole ecosystem of more specialized GIS libraries.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;The list of specialised maps packages is far too long for me to cover here. You can get &lt;a href="https://github.com/ropensci/mregions"&gt;marine regions&lt;/a&gt;, &lt;a href="https://github.com/ropenscilabs/rwdpa"&gt;protected areas&lt;/a&gt;, &lt;a href="https://github.com/chrisvwn/Rnightlights"&gt;nightlights&lt;/a&gt;, …, etc., etc.&lt;/p&gt;'><sup>33</sup></a> To convert these maps into “<strong>sf</strong>-friendly” data frame format, we can use the <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">sf::st_as_sf()</a></code> function as per the below examples.</p>
<div id="example-1-the-world" class="section level3" number="5.4.1">
<h3>
<span class="header-section-number">5.4.1</span> Example 1: The World<a class="anchor" aria-label="anchor" href="#example-1-the-world"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(maps) ## Already loaded</span>

<span class="va">world</span> <span class="op">=</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="fu">map</span><span class="op">(</span><span class="st">"world"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="va">world_map</span> <span class="op">=</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="va">world</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, col <span class="op">=</span> <span class="st">"grey40"</span>, lwd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"The world"</span>, 
    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"EPSG:"</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">world</span><span class="op">)</span><span class="op">$</span><span class="va">epsg</span><span class="op">)</span>
    <span class="op">)</span>
<span class="va">world_map</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/world1-1.png" width="672" style="display: block; margin: auto;"></div>
<p>All of the usual <strong>sf</strong> functions and transformations can then be applied. For example, we can reproject the above world map onto the <a href="https://proj.org/operations/projections/laea.html">Lambert Azimuthal Equal Area</a> projection (and further orientate it at the South Pole) as follows.</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">world_map</span> <span class="op">+</span>
  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"+proj=laea +y_0=0 +lon_0=155 +lat_0=-90"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Lambert Azimuthal Equal Area projection"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/world2-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="several-digressions-on-projection-considerations" class="section level3" number="5.4.2">
<h3>
<span class="header-section-number">5.4.2</span> Several digressions on projection considerations<a class="anchor" aria-label="anchor" href="#several-digressions-on-projection-considerations"><i class="fas fa-link"></i></a>
</h3>
<div id="winkel-tripel-projection" class="section level4" number="5.4.2.1">
<h4>
<span class="header-section-number">5.4.2.1</span> Winkel tripel projection<a class="anchor" aria-label="anchor" href="#winkel-tripel-projection"><i class="fas fa-link"></i></a>
</h4>
<p>As we’ve already seen, most map projections work great “out of the box” with <strong>sf</strong>. One niggling and notable exception is the <a href="https://en.wikipedia.org/wiki/Winkel_tripel_projection">Winkel tripel projection</a>. This is the preferred global map projection of <em>National Geographic</em> and requires a bit more work to get it to play nicely with <strong>sf</strong> and <strong>ggplot2</strong> (as detailed in <a href="https://github.com/r-spatial/sf/issues/509">this thread</a>). Here’s a quick example of how to do it:</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(lwgeom) ## Already loaded</span>

<span class="va">wintr_proj</span> <span class="op">=</span> <span class="st">"+proj=wintri +datum=WGS84 +no_defs +over"</span>

<span class="va">world_wintri</span> <span class="op">=</span> <span class="fu">lwgeom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lwgeom/man/st_transform_proj.html">st_transform_proj</a></span><span class="op">(</span><span class="va">world</span>, crs <span class="op">=</span> <span class="va">wintr_proj</span><span class="op">)</span>

<span class="co">## Don't necessarily need a graticule, but if you do then define it manually:</span>
<span class="va">gr</span> <span class="op">=</span> 
  <span class="fu">st_graticule</span><span class="op">(</span>lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">89.9</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">20</span><span class="op">)</span>,<span class="fl">89.9</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">lwgeom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lwgeom/man/st_transform_proj.html">st_transform_proj</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">wintr_proj</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">world_wintri</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">gr</span>, color <span class="op">=</span> <span class="st">"#cccccc"</span>, size <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span> <span class="op">+</span> <span class="co">## Manual graticule</span>
  <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, col <span class="op">=</span> <span class="st">"grey40"</span>, lwd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_sf</span><span class="op">(</span>datum <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_ipsum</span><span class="op">(</span>grid <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"The world"</span>, subtitle <span class="op">=</span> <span class="st">"Winkel tripel projection"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/wintri-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="equal-earth-projection" class="section level4" number="5.4.2.2">
<h4>
<span class="header-section-number">5.4.2.2</span> Equal Earth projection<a class="anchor" aria-label="anchor" href="#equal-earth-projection"><i class="fas fa-link"></i></a>
</h4>
<p>The latest and greatest projection, however, is the “<a href="http://equal-earth.com">Equal Earth</a>” projection. This <em>does</em> work well out of the box, in part due to the <code>ne_countries</code> dataset that comes bundled with the <strong>rnaturalearth</strong> package (<a href="https://github.com/ropensci/rnaturalearth">link</a>). I’ll explain that second part of the previous sentence in moment. But first let’s see the Equal Earth projection in action.</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(rnaturalearth) ## Already loaded</span>

<span class="va">countries</span> <span class="op">=</span> 
  <span class="fu">ne_countries</span><span class="op">(</span>returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">st_transform</span><span class="op">(</span><span class="fl">8857</span><span class="op">)</span> <span class="co">## Transform to equal earth projection</span>
  <span class="co"># st_transform("+proj=eqearth +wktext") ## PROJ string alternative</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">countries</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, col <span class="op">=</span> <span class="st">"grey40"</span>, lwd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"The world"</span>, subtitle <span class="op">=</span> <span class="st">"Equal Earth projection"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/equal_earth-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="pacfic-centered-maps-and-other-polygon-mishaps" class="section level4" number="5.4.2.3">
<h4>
<span class="header-section-number">5.4.2.3</span> Pacfic-centered maps and other polygon mishaps<a class="anchor" aria-label="anchor" href="#pacfic-centered-maps-and-other-polygon-mishaps"><i class="fas fa-link"></i></a>
</h4>
<p>As noted, the <code><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html">rnaturalearth::ne_countries</a></code> spatial data frame is important for correctly displaying the Equal Earth projection. On the face of it, this looks pretty similar to our <code><a href="https://rdrr.io/pkg/maps/man/world.html">maps::world</a></code> spatial data frame from earlier. They both contain polygons of all the countries in the world and appear to have similar default projections. However, some underlying nuances in how those polygons are constructed allows us avoid some undesirable visual artefacts that arise when reprojecting to the Equal Earth projection. Consider:</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">world</span> <span class="op">%&gt;%</span>
  <span class="fu">st_transform</span><span class="op">(</span><span class="fl">8857</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Transform to equal earth projection</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, col <span class="op">=</span> <span class="st">"grey40"</span>, lwd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"The... uh, world"</span>, subtitle <span class="op">=</span> <span class="st">"Projection fail"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/equal_earth_bad-1.png" width="672" style="display: block; margin: auto;"></div>
<p>These types of visual artefacts are particularly common for Pacific-centered maps and, in that case, arise from polygons extending over the Greenwich prime meridian. It’s a suprisingly finicky problem to solve. Even the <strong>rnaturalearth</strong> doesn’t do a good job. Luckily, Nate Miller has you covered with an <a href="https://github.com/natemiller/mapping">excellent guide</a> to set you on the right track.</p>
</div>
</div>
<div id="example-2-a-single-country-i.e.-norway" class="section level3" number="5.4.3">
<h3>
<span class="header-section-number">5.4.3</span> Example 2: A single country (i.e. Norway)<a class="anchor" aria-label="anchor" href="#example-2-a-single-country-i.e.-norway"><i class="fas fa-link"></i></a>
</h3>
<p>The <strong>maps</strong> and <strong>mapdata</strong> packages have detailed county- and province-level data for several individual nations. We’ve already seen this with France, but it includes the USA, New Zealand and several other nations. However, we can still use it to extract a specific country’s border using some intuitive syntax. For example, we could plot a base map of Norway as follows.</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">norway</span> <span class="op">=</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="fu">map</span><span class="op">(</span><span class="st">"world"</span>, <span class="st">"norway"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="co">## For a hi-resolution map (if you *really* want to see all the fjords):</span>
<span class="co"># norway = st_as_sf(map("worldHires", "norway", plot = FALSE, fill = TRUE))</span>

<span class="va">norway</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"black"</span>, col<span class="op">=</span><span class="cn">NA</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/norway-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Hmmm. Looks okay, but I don’t really want to include non-mainland territories like Svalbaard (to the north) and the Faroe Islands (to the east). This gives me the chance to show off another handy function, <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">sf::st_crop()</a></code>, which I’ll use to crop our <strong>sf</strong> object to a specific extent (i.e. rectangle). While I am at, we could also improve the projection. The Norwegian Mapping Authority recommends the ETRS89 / UTM projection, for which we can easily obtain the equivalent EPSG code (i.e. 25832) from <a href="https://epsg.io/25832">this website</a>.</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">norway</span> <span class="op">%&gt;%</span>
  <span class="fu">st_crop</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>xmin<span class="op">=</span><span class="fl">0</span>, xmax<span class="op">=</span><span class="fl">35</span>, ymin<span class="op">=</span><span class="fl">0</span>, ymax<span class="op">=</span><span class="fl">72</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">st_transform</span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">25832</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"black"</span>, col<span class="op">=</span><span class="cn">NA</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/norway_fixed-1.png" width="672" style="display: block; margin: auto;"></div>
<p>There you go. A nice-looking map of Norway. Fairly appropriate that it resembles a gnarly black metal guitar.</p>
<blockquote>
<p><strong>Aside:</strong> I recommend detaching the <strong>maps</strong> package once you’re finished using it, since it avoids potential namespace conflicts with <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map</a></code>.</p>
</blockquote>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="va">package</span><span class="op">:</span><span class="va">maps</span><span class="op">)</span> <span class="co">## To avoid potential purrr::map() conflicts</span></code></pre></div>
</div>
</div>
<div id="census" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> BONUS 1: US Census data with <strong>tidycensus</strong> and <strong>tigris</strong><a class="anchor" aria-label="anchor" href="#census"><i class="fas fa-link"></i></a>
</h2>
<blockquote>
<p><strong>Note:</strong> Before continuing with this section, you will first need to <a href="https://api.census.gov/data/key_signup.html">request an API key</a> from the Census.</p>
</blockquote>
<p>Working with Census data has traditionally quite a pain. You need to register on the website, then download data from various years or geographies separately, merge these individual files, etc. Thankfully, this too has recently become much easier thanks to the Census API and — for R at least — the <strong>tidycensus</strong> (<a href="https://walker-data.com/tidycensus/">link</a>) and <strong>tigris</strong> (<a href="https://github.com/walkerke/tigris">link</a>) packages from <a href="http://walkerke.github.io/">Kyle Walker</a> (a UO alum). This next section will closely follow a <a href="http://walkerke.github.io/2017/06/comparing-metros/">tutorial</a> on his website.</p>
<p>We start by loading the packages and setting our Census API key. Note that I’m not actually running the below chunk, since I expect you to fill in your own Census key. You only have to run this function once.</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(tidycensus) ## Already loaded</span>
<span class="co"># library(tigris) ## Already loaded</span>

<span class="co">## Replace the below with your own census API key. We'll use the "install = TRUE"</span>
<span class="co">## option to save the key for future use, so we only ever have to run this once.</span>
<span class="fu">census_api_key</span><span class="op">(</span><span class="st">"YOUR_CENSUS_API_KEY_HERE"</span>, install <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co">## Also tell the tigris package to automatically cache its results to save on</span>
<span class="co">## repeated downloading. I recommend adding this line to your ~/.Rprofile file</span>
<span class="co">## so that caching is automatically enabled for future sessions. A quick way to</span>
<span class="co">## do that is with the `usethis::edit_r_profile()` function.</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>tigris_use_cache<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>Let’s say that our goal is to provide a snapshot of Census rental estimates across different cities in the Pacific Northwest. We start by downloading tract-level rental data for Oregon and Washington using the <code><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">tidycensus::get_acs()</a></code> function. Note that you’ll need to look up the correct ID variable (in this case: “DP04_0134”).</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rent</span> <span class="op">=</span> 
  <span class="fu">tidycensus</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">get_acs</a></span><span class="op">(</span>
    geography <span class="op">=</span> <span class="st">"tract"</span>, variables <span class="op">=</span> <span class="st">"DP04_0134"</span>,
    state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"WA"</span>, <span class="st">"OR"</span><span class="op">)</span>, geometry <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
<span class="va">rent</span></code></pre></div>
<pre><code>#&gt; Simple feature collection with 2292 features and 5 fields (with 10 geometries empty)
#&gt; geometry type:  MULTIPOLYGON
#&gt; dimension:      XY
#&gt; bbox:           xmin: -124.7631 ymin: 41.99179 xmax: -116.4635 ymax: 49.00249
#&gt; geographic CRS: NAD83
#&gt; # A tibble: 2,292 x 6
#&gt;    GEOID  NAME         variable estimate   moe                          geometry
#&gt;    &lt;chr&gt;  &lt;chr&gt;        &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;                &lt;MULTIPOLYGON [°]&gt;
#&gt;  1 53061… Census Trac… DP04_01…     1181   168 (((-122.2311 48.00875, -122.2288…
#&gt;  2 53033… Census Trac… DP04_01…     1208    97 (((-122.3551 47.52103, -122.3551…
#&gt;  3 53077… Census Trac… DP04_01…      845   208 (((-120.9789 46.66908, -120.9792…
#&gt;  4 53033… Census Trac… DP04_01…     1727   112 (((-122.3555 47.65542, -122.3555…
#&gt;  5 53027… Census Trac… DP04_01…      727   147 (((-123.7275 47.07135, -123.7264…
#&gt;  6 53061… Census Trac… DP04_01…     2065   331 (((-122.1409 48.06446, -122.1402…
#&gt;  7 53033… Census Trac… DP04_01…     1333   142 (((-122.3551 47.50711, -122.3551…
#&gt;  8 53077… Census Trac… DP04_01…     1290   155 (((-120.5724 46.59989, -120.5619…
#&gt;  9 53011… Census Trac… DP04_01…     1272    62 (((-122.5589 45.62102, -122.5548…
#&gt; 10 53021… Census Trac… DP04_01…      550   189 (((-119.0936 46.28581, -119.0934…
#&gt; # … with 2,282 more rows</code></pre>
<p>This returns an <strong>sf</strong> object, which we can plot directly.</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rent</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">estimate</span>, color <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">26910</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Rent ($)"</span>, labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/label_number.html">comma</a></span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_color_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Rent ($)"</span>, labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/label_number.html">comma</a></span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Rental rates across Oregon and Washington"</span>, 
    caption <span class="op">=</span> <span class="st">"Data: US Census Bureau"</span>
    <span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/rent_plot-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Hmmm, looks like you want to avoid renting in Seattle if possible…</p>
<p>The above map provides rental information for pretty much all of the Pacific Northwest. Perhaps we’re not interested in such a broad swatch of geography. What if we’d rather get a sense of rents within some smaller and well-defined metropolitan areas? Well, we’d need some detailed geographic data for starters, say from the <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html">TIGER/Line shapefiles</a> collection. The good news is that the <strong>tigris</strong> package has you covered here. For example, let’s say we want to narrow down our focus and compare rents across three Oregon metros: Portland (and surrounds), Corvallis, and Eugene.</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">or_metros</span> <span class="op">=</span> 
  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/core_based_statistical_areas.html">core_based_statistical_areas</a></span><span class="op">(</span>cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># filter(GEOID %in% c("21660", "18700", "38900")) %&gt;% ## Could use GEOIDs directly if you know them </span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Portland|Corvallis|Eugene"</span>, <span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"OR"</span>, <span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Filter out Portland, ME</span>
  <span class="fu">select</span><span class="op">(</span>metro_name <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span></code></pre></div>
<p>Now we do a spatial join on our two data sets using the <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> function.</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">or_rent</span> <span class="op">=</span> 
  <span class="fu">st_join</span><span class="op">(</span>
    <span class="va">rent</span>, 
    <span class="va">or_metros</span>, 
    join <span class="op">=</span> <span class="va">st_within</span>, left <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span> 
<span class="va">or_rent</span>
<span class="co">#&gt; Simple feature collection with 595 features and 6 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -124.1587 ymin: 43.43739 xmax: -121.5144 ymax: 46.38863</span>
<span class="co">#&gt; geographic CRS: NAD83</span>
<span class="co">#&gt; # A tibble: 595 x 7</span>
<span class="co">#&gt;    GEOID  NAME   variable estimate   moe                    geometry metro_name </span>
<span class="co">#&gt;  * &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;          &lt;MULTIPOLYGON [°]&gt; &lt;chr&gt;      </span>
<span class="co">#&gt;  1 53011… Censu… DP04_01…     1272    62 (((-122.5589 45.62102, -12… Portland-V…</span>
<span class="co">#&gt;  2 53011… Censu… DP04_01…     1185   112 (((-122.5528 45.69343, -12… Portland-V…</span>
<span class="co">#&gt;  3 53011… Censu… DP04_01…      866    64 (((-122.6143 45.63259, -12… Portland-V…</span>
<span class="co">#&gt;  4 53011… Censu… DP04_01…     1268    62 (((-122.5282 45.60814, -12… Portland-V…</span>
<span class="co">#&gt;  5 53011… Censu… DP04_01…     1268   267 (((-122.6002 45.78026, -12… Portland-V…</span>
<span class="co">#&gt;  6 53011… Censu… DP04_01…     1274   107 (((-122.5603 45.66535, -12… Portland-V…</span>
<span class="co">#&gt;  7 53011… Censu… DP04_01…     1092    77 (((-122.3562 45.57666, -12… Portland-V…</span>
<span class="co">#&gt;  8 53011… Censu… DP04_01…     1427   106 (((-122.6576 45.69122, -12… Portland-V…</span>
<span class="co">#&gt;  9 53011… Censu… DP04_01…     1148   132 (((-122.667 45.6664, -122.… Portland-V…</span>
<span class="co">#&gt; 10 53011… Censu… DP04_01…     1074    76 (((-122.6716 45.62722, -12… Portland-V…</span>
<span class="co">#&gt; # … with 585 more rows</span></code></pre></div>
<p>One useful way to summarize this data and compare across metros is with a histogram. Note that “regular” <strong>ggplot2</strong> geoms and functions play perfectly nicely with <strong>sf</strong> objects (i.e. we aren’t limited to <code>geom_sf()</code>).</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">or_rent</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_histogram</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">metro_name</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/or_rent_plot-1.png" width="672" style="display: block; margin: auto;"></div>
<p>That’s a quick taste of working with <strong>tidycensus</strong> (and <strong>tigris</strong>). In truth, the package can do a lot more than I’ve shown you here. For example, you can also use it to download a variety of other Census microdata such as PUMS, which is much more detailed. See the <strong>tidycensus</strong> <a href="https://walker-data.com/tidycensus/">website</a> for more information.</p>
</div>
<div id="bonus-2-interactive-maps" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> BONUS 2: Interactive maps<a class="anchor" aria-label="anchor" href="#bonus-2-interactive-maps"><i class="fas fa-link"></i></a>
</h2>
<p>Now that you’ve grasped the basic properties of <strong>sf</strong> objects and how to plot them using <strong>ggplot2</strong>, its time to scale up with interactive maps.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;The ability to easily plot interactive maps from R is one of the main reasons that I switched all of my public presentations from PDFs to R Markdown-driven HMTL.&lt;/p&gt;"><sup>34</sup></a> You have several package options here. But I think the best are <strong>leaflet</strong> (<a href="https://rstudio.github.io/leaflet/">link</a>) and friends, or <strong>plotly</strong> (<a href="https://github.com/ropensci/plotly">link</a>). We’ve already covered the latter in a previous lecture, so I’ll simply redirect interested parties to <a href="https://plotly-r.com/maps.html">this link</a> for some map-related examples examples. To expand on the former in more depth, <a href="https://leafletjs.com/">leaflet.js</a> is a lightweight JavaScript library for interactive mapping that has become extremely popular in recent years. You would have seen it being used across all the major news media publications (<em>New York Times</em>, <em>Washington Post</em>, <em>The Economist</em>, etc.). The good people at RStudio have kindly packaged a version of <strong>leaflet</strong> for R, which basically acts as a wrapper to the underlying JavaScript library.</p>
<p>The <strong>leaflet</strong> syntax is a little different to what you’ve seen thus far and I strongly encourage you to visit the package’s <a href="https://rstudio.github.io/leaflet/">excellent website</a> for the full set of options. However, a key basic principle that it shares with <strong>ggplot2</strong> is that you <em>build your plot in layers</em>. Here’s an example adapted from <a href="https://juliasilge.com/blog/using-tidycensus/">Julia Silge</a>, which builds on the <strong>tidycensus</strong> package that we saw above. This time, our goal is to plot county-level population densities for Oregon as a whole and produce some helpful popup text if a user clicks on a particular county. First, we download the data using <strong>tidycensus</strong> and inspect the resulting data frame.</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(tidycensus) ## Already loaded</span>

<span class="va">oregon</span> <span class="op">=</span> 
  <span class="fu">get_acs</span><span class="op">(</span>
    geography <span class="op">=</span> <span class="st">"county"</span>, variables <span class="op">=</span> <span class="st">"B01003_001"</span>,
    state <span class="op">=</span> <span class="st">"OR"</span>, geometry <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span> 
<span class="va">oregon</span></code></pre></div>
<pre><code>#&gt; Simple feature collection with 36 features and 5 fields
#&gt; geometry type:  MULTIPOLYGON
#&gt; dimension:      XY
#&gt; bbox:           xmin: -124.5662 ymin: 41.99179 xmax: -116.4635 ymax: 46.29204
#&gt; geographic CRS: NAD83
#&gt; First 10 features:
#&gt;    GEOID                     NAME   variable estimate moe
#&gt; 1  41017 Deschutes County, Oregon B01003_001   186251  NA
#&gt; 2  41003    Benton County, Oregon B01003_001    91107  NA
#&gt; 3  41015     Curry County, Oregon B01003_001    22650  NA
#&gt; 4  41061     Union County, Oregon B01003_001    26337  NA
#&gt; 5  41055   Sherman County, Oregon B01003_001     1642 114
#&gt; 6  41051 Multnomah County, Oregon B01003_001   804606  NA
#&gt; 7  41007   Clatsop County, Oregon B01003_001    39102  NA
#&gt; 8  41033 Josephine County, Oregon B01003_001    86251  NA
#&gt; 9  41031 Jefferson County, Oregon B01003_001    23607  NA
#&gt; 10 41039      Lane County, Oregon B01003_001   373340  NA
#&gt;                          geometry
#&gt; 1  MULTIPOLYGON (((-122.0019 4...
#&gt; 2  MULTIPOLYGON (((-123.8167 4...
#&gt; 3  MULTIPOLYGON (((-124.3239 4...
#&gt; 4  MULTIPOLYGON (((-118.6978 4...
#&gt; 5  MULTIPOLYGON (((-121.0312 4...
#&gt; 6  MULTIPOLYGON (((-122.9292 4...
#&gt; 7  MULTIPOLYGON (((-123.5989 4...
#&gt; 8  MULTIPOLYGON (((-124.042 42...
#&gt; 9  MULTIPOLYGON (((-121.8495 4...
#&gt; 10 MULTIPOLYGON (((-124.1503 4...</code></pre>
<p>So, the popup text of interest is held within the “NAME” and “estimate” columns. I’ll use a bit of regular expression work to extract the county name from the “NAME” column (i.e. without the state) and then build up the map layer by layer. Note that the <strong>leaflet</strong> syntax requires that I prepend variables names with a tilde (<code><a href="https://rdrr.io/r/base/tilde.html">~</a></code>) when I refer to them in the plot building process. This tilde operates in much the same way as the asthetics (<code>aes()</code>) function does in <strong>ggplot2</strong>. One other thing to note is that I need to define a colour palette — which I’ll call <code>col_pal</code> here — separately from the main plot. This is a bit of an inconvenience if you’re used to the fully-integrated <strong>ggplot2</strong> API, but only a small one.</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(leaflet) ## Already loaded</span>

<span class="va">col_pal</span> <span class="op">=</span> <span class="fu">colorQuantile</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"viridis"</span>, domain <span class="op">=</span> <span class="va">oregon</span><span class="op">$</span><span class="va">estimate</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="va">oregon</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>county <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">",.*"</span>, <span class="st">""</span>, <span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Get rid of everything after the first comma</span>
  <span class="fu">st_transform</span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">leaflet</span><span class="op">(</span>width <span class="op">=</span> <span class="st">"100%"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">addProviderTiles</span><span class="op">(</span>provider <span class="op">=</span> <span class="st">"CartoDB.Positron"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">addPolygons</span><span class="op">(</span>
    popup <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">county</span>, <span class="st">"&lt;br&gt;"</span>, <span class="st">"Population: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">prettyNum</a></span><span class="op">(</span><span class="va">estimate</span>, big.mark<span class="op">=</span><span class="st">","</span><span class="op">)</span><span class="op">)</span>,
    stroke <span class="op">=</span> <span class="cn">FALSE</span>,
    smoothFactor <span class="op">=</span> <span class="fl">0</span>,
    fillOpacity <span class="op">=</span> <span class="fl">0.7</span>,
    color <span class="op">=</span> <span class="op">~</span><span class="fu">col_pal</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">addLegend</span><span class="op">(</span>
    <span class="st">"bottomright"</span>, 
    pal <span class="op">=</span> <span class="va">col_pal</span>, 
    values <span class="op">=</span> <span class="op">~</span><span class="va">estimate</span>,
    title <span class="op">=</span> <span class="st">"Population percentiles"</span>,
    opacity <span class="op">=</span> <span class="fl">1</span>
    <span class="op">)</span></code></pre></div>
<iframe src="http://grantmcdermott.com/ds4e-extras/spatial/oregon_leaflet.html" width="672" height="400px">
</iframe>
<p>No suprises here. The bulk of Oregon’s population is situated just west of the Cascades, in cities connected along the I-5.</p>
<p>A particularly useful feature of interactive maps is not being limited by scale or granularity, so you can really dig in to specific areas and neighbourhoods. Here’s an example using home values from Lane County.</p>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lane</span> <span class="op">=</span> 
  <span class="fu">get_acs</span><span class="op">(</span>
    geography <span class="op">=</span> <span class="st">"tract"</span>, variables <span class="op">=</span> <span class="st">"B25077_001"</span>, 
    state <span class="op">=</span> <span class="st">"OR"</span>, county <span class="op">=</span> <span class="st">"Lane County"</span>, geometry <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
<span class="co">#&gt; Getting data from the 2015-2019 5-year ACS</span>
<span class="co">#&gt; Downloading feature geometry from the Census website.  To cache shapefiles for use in future sessions, set `options(tigris_use_cache = TRUE)`.</span></code></pre></div>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lane_pal</span> <span class="op">=</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"plasma"</span>, domain <span class="op">=</span> <span class="va">lane</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span>

<span class="va">lane</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>tract <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">",.*"</span>, <span class="st">""</span>, <span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Get rid of everything after the first comma</span>
  <span class="fu">st_transform</span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">leaflet</span><span class="op">(</span>width <span class="op">=</span> <span class="st">"100%"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">addProviderTiles</span><span class="op">(</span>provider <span class="op">=</span> <span class="st">"CartoDB.Positron"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">addPolygons</span><span class="op">(</span>
    <span class="co"># popup = ~tract,</span>
    popup <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">tract</span>, <span class="st">"&lt;br&gt;"</span>, <span class="st">"Median value: $"</span>, <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">prettyNum</a></span><span class="op">(</span><span class="va">estimate</span>, big.mark<span class="op">=</span><span class="st">","</span><span class="op">)</span><span class="op">)</span>,
    stroke <span class="op">=</span> <span class="cn">FALSE</span>,
    smoothFactor <span class="op">=</span> <span class="fl">0</span>,
    fillOpacity <span class="op">=</span> <span class="fl">0.5</span>,
    color <span class="op">=</span> <span class="op">~</span><span class="fu">lane_pal</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">addLegend</span><span class="op">(</span>
    <span class="st">"bottomright"</span>, 
    pal <span class="op">=</span> <span class="va">lane_pal</span>, 
    values <span class="op">=</span> <span class="op">~</span><span class="va">estimate</span>,
    title <span class="op">=</span> <span class="st">"Median home values&lt;br&gt;Lane County, OR"</span>,
    labFormat <span class="op">=</span> <span class="fu">labelFormat</span><span class="op">(</span>prefix <span class="op">=</span> <span class="st">"$"</span><span class="op">)</span>,
    opacity <span class="op">=</span> <span class="fl">1</span>
    <span class="op">)</span></code></pre></div>
<iframe src="http://grantmcdermott.com/ds4e-extras/spatial/lane_leaflet.html" width="672" height="400px">
</iframe>
<p>Having tried to convince you of the conceptual similarities between building maps with either <strong>leaflet</strong> or <strong>ggplot2</strong> — layering etc. — there’s no denying that the syntax does take some getting used to. If you only plan to spin up the occasional interactive map, that cognitive overhead might be more effort than it’s worth. The good news is that R spatial community has created the <strong>mapview</strong> package (<a href="https://r-spatial.github.io/mapview/">link</a>) for very quickly generating interactive maps. Behind the scenes, it uses <strong>leaflet</strong> to power everything, alongside some sensible defaults. Here’s a quick example that recreates our Lane county home value map from above.</p>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(mapview) ## Already loaded</span>

<span class="fu">mapview</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview</a></span><span class="op">(</span><span class="va">lane</span>, zcol <span class="op">=</span> <span class="st">"estimate"</span>, 
                 layer.name <span class="op">=</span> <span class="st">'Median home values&lt;br&gt;Lane County, OR'</span><span class="op">)</span></code></pre></div>
<iframe src="http://grantmcdermott.com/ds4e-extras/spatial/lane_mapview.html" width="672" height="400px">
</iframe>
<p>Super easy, no? While it doesn’t offer quite the same flexibility as the native <strong>leaflet</strong> syntax, <strong>mapview</strong> is a great way to get decent interactive maps up and running with minimal effort.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;I also want to flag the companion &lt;strong&gt;mapedit&lt;/strong&gt; package (&lt;a href="https://github.com/r-spatial/mapedit"&gt;link&lt;/a&gt;), which lets you &lt;em&gt;edit&lt;/em&gt; maps interactively by hand (e.g. redrawing polygons). I’ve used it for some of my projects and it works very well.&lt;/p&gt;'><sup>35</sup></a></p>
</div>
<div id="bonus-3-other-map-plotting-options-plot-tmap-etc." class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> BONUS 3: Other map plotting options (<strong>plot</strong>, <strong>tmap</strong>, etc.)<a class="anchor" aria-label="anchor" href="#bonus-3-other-map-plotting-options-plot-tmap-etc."><i class="fas fa-link"></i></a>
</h2>
<p>While I think that <strong>ggplot2</strong> (together with <strong>sf</strong>) and <strong>leaflet</strong> are the best value bet for map plotting in R — especially for relative newcomers that have been inculcated into the tidyverse ecosystem — it should be said that there are many other options available to you. The base R <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> function is <em>very</em> powerful and handles all manner of spatial objects. (It is also very fast.) The package that I’ll highlight briefly in closing, however, is <strong>tmap</strong> (<a href="https://mtennekes.github.io/tmap/index.html">link</a>). The focus of <strong>tmap</strong> is <em>thematic maps</em> that are “production ready.” The package is extremely flexible and can accept various spatial objects and output various map types (including interactive). Moreover, the syntax should look very familar to us, since it is inspired by <code>ggplot2</code>’s layered graphics of grammar approach. Here’s an example of a great looking map taken from the <strong>tmap</strong> <a href="https://mtennekes.github.io/tmap/index.html">homepage</a>.</p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(tmap) ## Already loaded</span>
<span class="co"># library(tmaptools) ## Already loaded</span>

<span class="co">## Load elevation raster data, and country polygons</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">land</span>, <span class="va">World</span><span class="op">)</span>

<span class="co">## Convert to Eckert IV projection</span>
<span class="va">land_eck4</span> <span class="op">=</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">land</span>, <span class="st">"+proj=eck4"</span><span class="op">)</span>

<span class="co">## Plot</span>
<span class="fu">tm_shape</span><span class="op">(</span><span class="va">land_eck4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_raster</span><span class="op">(</span>
    <span class="st">"elevation"</span>, 
    breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">250</span>, <span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">1500</span>, <span class="fl">2000</span>, <span class="fl">2500</span>, <span class="fl">3000</span>, <span class="fl">4000</span>, <span class="cn">Inf</span><span class="op">)</span>,  
    palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">terrain.colors</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>, 
    title<span class="op">=</span><span class="st">"Elevation"</span>
    <span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">World</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_borders</span><span class="op">(</span><span class="st">"grey20"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_graticules</span><span class="op">(</span>labels.size <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_text</span><span class="op">(</span><span class="st">"name"</span>, size<span class="op">=</span><span class="st">"AREA"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_compass</span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.65</span>, <span class="fl">.15</span><span class="op">)</span>, color.light <span class="op">=</span> <span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_credits</span><span class="op">(</span><span class="st">"Eckert IV projection"</span>, position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RIGHT"</span>, <span class="st">"BOTTOM"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_style</span><span class="op">(</span><span class="st">"classic"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_layout</span><span class="op">(</span>
    inner.margins<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.04</span>,<span class="fl">.03</span>, <span class="fl">.02</span>, <span class="fl">.01</span><span class="op">)</span>,
    legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>,
    legend.frame <span class="op">=</span> <span class="cn">TRUE</span>,
    bg.color<span class="op">=</span><span class="st">"lightblue"</span>,
    legend.bg.color<span class="op">=</span><span class="st">"lightblue"</span>,
    earth.boundary <span class="op">=</span> <span class="cn">TRUE</span>,
    space.color<span class="op">=</span><span class="st">"grey90"</span>
    <span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="spatial_files/figure-html/tmap-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="further-reading" class="section level2" number="5.8">
<h2>
<span class="header-section-number">5.8</span> Further reading<a class="anchor" aria-label="anchor" href="#further-reading"><i class="fas fa-link"></i></a>
</h2>
<p>You could easily spend a whole semester (or degree!) on spatial analysis and, more broadly, geocomputation. I’ve simply tried to give you as much useful information as can reasonably be contained in one lecture. Here are some resources for further reading and study:</p>
<ul>
<li>The package websites that I’ve linked to throughout this tutorial are an obvious next port of call for delving deeper into their functionality: <a href="https://github.com/r-spatial/sf"><strong>sf</strong></a>, <a href="https://rstudio.github.io/leaflet/"><strong>leaflet</strong></a>, etc.</li>
<li>The best overall resource right now may be <a href="https://geocompr.robinlovelace.net/index.html"><em>Geocomputation with R</em></a>, a superb new text by Robin Lovelace, Jakub Nowosad, and Jannes Muenchow. This is a “living,” open-source document, which is constantly updated by its authors and features a very modern approach to working with geographic data. Highly recommended.</li>
<li>Similarly, the rockstar team behind <strong>sf</strong>, Edzer Pebesma and Roger Bivand, are busy writing their own book, <a href="https://www.r-spatial.org/book/"><em>Spatial Data Science</em></a>. This project is currently less developed, but I expect it to become the key reference point in years to come. Imporantly, both of the above books cover <strong>raster-based</strong> spatial data.</li>
<li>On the subject of raster data… If you’re in the market for shorter guides, Jamie Montgomery has a great introduction to rasters <a href="https://jamiecmontgomery.github.io/spatial-analysis-R/intro_spatial_data_R.html">here</a>. At a more advanced level, the <strong>sf</strong> team is busy developing a <a href="https://github.com/r-spatial/stars">new package</a> called <strong>stars</strong>, which will provide equivalent functionality (among other things) for raster data. <strong>UPDATE:</strong> I ended up caving and wrote up a short set of bonus notes on rasters <a href="https://raw.githack.com/uo-ec607/lectures/master/09a-spatial-rasters/09a-spatial-rasters.html">here</a>.</li>
<li>If you want more advice on drawing maps, including a bunch that we didn’t cover today (choropleths, state-bins, etc.), Kieran Healy’s <a href="https://socviz.co/maps.html#maps"><em>Data Vizualisation</em></a> book has you covered.</li>
<li>Something else we didn’t really cover at all today was <strong>spatial statistics</strong>. This too could be subject to a degree-length treatment. However, for now I’ll simply point you to <a href="https://spacetimewithr.org/"><em>Spatio-Temporal Statistics with R</em></a>, by Christopher Wikle and coauthors. (Another free book!) Finally, since it is likely the most interesting thing for economists working with spatial data, I’ll also add that Darin Christensen and Thiemo Fetzer have written a very fast R-implementation (via C++) of Conley standard errors. The GitHub repo is <a href="https://github.com/darinchristensen/conley-se">here</a>. See their original <a href="https://darinchristensen.com/post/2015-08-30-conley/">blog post</a> (and <a href="https://darinchristensen.com/post/2017-08-21-correction/">update</a>) for more details.</li>
</ul>
</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="parallel.html"><span class="header-section-number">4</span> Parallel programming</a></div>
<div class="next"><a href="gce-i.html"><span class="header-section-number">6</span> Google Compute Engine (I)</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#spatial-analysis"><span class="header-section-number">5</span> Spatial analysis</a></li>
<li>
<a class="nav-link" href="#requirements"><span class="header-section-number">5.1</span> Requirements</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#external-libraries-requirements-vary-by-os"><span class="header-section-number">5.1.1</span> External libraries (requirements vary by OS)</a></li>
<li><a class="nav-link" href="#r-packages-3"><span class="header-section-number">5.1.2</span> R packages</a></li>
<li><a class="nav-link" href="#census-api-key"><span class="header-section-number">5.1.3</span> Census API key</a></li>
</ul>
</li>
<li><a class="nav-link" href="#introduction-crs-and-map-projections"><span class="header-section-number">5.2</span> Introduction: CRS and map projections</a></li>
<li>
<a class="nav-link" href="#simple-features-and-the-sf-package"><span class="header-section-number">5.3</span> Simple Features and the sf package</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#reading-in-spatial-data"><span class="header-section-number">5.3.1</span> Reading in spatial data</a></li>
<li><a class="nav-link" href="#simple-features-as-data-frames"><span class="header-section-number">5.3.2</span> Simple Features as data frames</a></li>
<li><a class="nav-link" href="#plotting-and-projection-with-ggplot2"><span class="header-section-number">5.3.3</span> Plotting and projection with ggplot2</a></li>
<li><a class="nav-link" href="#data-wrangling-with-dplyr-and-tidyr"><span class="header-section-number">5.3.4</span> Data wrangling with dplyr and tidyr</a></li>
<li><a class="nav-link" href="#geometric"><span class="header-section-number">5.3.5</span> Specialized geometric operations</a></li>
<li><a class="nav-link" href="#aside-sf-and-data.table"><span class="header-section-number">5.3.6</span> Aside: sf and data.table</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#where-to-get-map-data"><span class="header-section-number">5.4</span> Where to get map data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#example-1-the-world"><span class="header-section-number">5.4.1</span> Example 1: The World</a></li>
<li><a class="nav-link" href="#several-digressions-on-projection-considerations"><span class="header-section-number">5.4.2</span> Several digressions on projection considerations</a></li>
<li><a class="nav-link" href="#example-2-a-single-country-i.e.-norway"><span class="header-section-number">5.4.3</span> Example 2: A single country (i.e. Norway)</a></li>
</ul>
</li>
<li><a class="nav-link" href="#census"><span class="header-section-number">5.5</span> BONUS 1: US Census data with tidycensus and tigris</a></li>
<li><a class="nav-link" href="#bonus-2-interactive-maps"><span class="header-section-number">5.6</span> BONUS 2: Interactive maps</a></li>
<li><a class="nav-link" href="#bonus-3-other-map-plotting-options-plot-tmap-etc."><span class="header-section-number">5.7</span> BONUS 3: Other map plotting options (plot, tmap, etc.)</a></li>
<li><a class="nav-link" href="#further-reading"><span class="header-section-number">5.8</span> Further reading</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/grantmcdermott/ds4e/blob/master/spatial.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/grantmcdermott/ds4e/edit/master/spatial.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Data Science for Economists and Other Animals</strong>" was written by Grant McDermott and Ed Rubin. It was last built on 2021-04-23.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
